{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "ac1db589",
   "metadata": {},
   "outputs": [],
   "source": [
    "import itertools as it\n",
    "import matplotlib.pyplot as plt"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "c488192b",
   "metadata": {},
   "outputs": [],
   "source": [
    "x,y = var(\"x,y\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "79dd8227",
   "metadata": {},
   "outputs": [],
   "source": [
    "R.<r,p> = QQ[]\n",
    "F = R.fraction_field()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "ff47bac3",
   "metadata": {},
   "outputs": [],
   "source": [
    "%%time\n",
    "N = 4\n",
    "\n",
    "states = list(it.product((0,1), range(N)))\n",
    "istates = { s:i for i,s in enumerate(states) }\n",
    "\n",
    "Pmor = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pbin = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pber = matrix(F, [[0]* len(states)] * len(states))\n",
    "\n",
    "Pmor[0,0] = Pbin[0,0] = Pber[0,0] = 1\n",
    "Pmor[len(states)-1, len(states)-1] = Pbin[len(states)-1, len(states)-1] = Pber[len(states)-1, len(states)-1] = 1\n",
    "\n",
    "for i in range(N):\n",
    "    # null center\n",
    "    if i:\n",
    "        Pmor[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i)\n",
    "        Pber[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "        Pbin[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "\n",
    "        Pmor[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) / i / (N-1)\n",
    "        Pber[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) / i / (N-1)\n",
    "        Pbin[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) / i / (N-1)\n",
    "    \n",
    "    if i != N-1:\n",
    "        Pmor[istates[(1,i)],istates[(1,i+1)]] = r / (r*i + N-i) * (N-i) / (N-1)\n",
    "        Pber[istates[(1,i)],istates[(1,N-1)]] = r / (r*i + N-i) * p\n",
    "        for k in range(1,N-i):\n",
    "            Pbin[istates[(1,i)],istates[(1,i+k)]] = r / (r*i + N-i) * binomial(N-i, k) * p**k * (1-p)**(N-i - k)\n",
    "\n",
    "        Pmor[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*i + N-i)\n",
    "        Pber[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*i + N-i)\n",
    "        Pbin[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*i + N-i)\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way.. \n",
    "Pmor = Pmor.change_ring(SR).change_ring(F)\n",
    "Pber = Pber.change_ring(SR).change_ring(F)\n",
    "Pbin = Pbin.change_ring(SR).change_ring(F)\n",
    "\n",
    "Qmor = identity_matrix(len(states)-2) - Pmor[1:-1,1:-1]\n",
    "Qbin = identity_matrix(len(states)-2) - Pbin[1:-1,1:-1]\n",
    "Qber = identity_matrix(len(states)-2) - Pber[1:-1,1:-1]\n",
    "\n",
    "Phimor = Qmor.solve_right(vector(Pmor[1:-1,-1]))\n",
    "Phibin = Qbin.solve_right(vector(Pbin[1:-1,-1]))\n",
    "Phiber = Qber.solve_right(vector(Pber[1:-1,-1]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way\n",
    "Phimor = Phimor.change_ring(SR).change_ring(F)\n",
    "Phibin = Phibin.change_ring(SR).change_ring(F)\n",
    "Phiber = Phiber.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBin = Qbin.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBin = TimeBin.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBer = Qber.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBer = TimeBer.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMor = Qmor.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMor = TimeMor.change_ring(SR).change_ring(F)\n",
    "\n",
    "# Conditionated times\n",
    "PmorF = copy(Pmor)\n",
    "PberF = copy(Pber)\n",
    "PbinF = copy(Pbin)\n",
    "\n",
    "for i in range(1,len(states)-1):\n",
    "    PmorF.rescale_col(i, Phimor[i-1])\n",
    "    PmorF.rescale_row(i, 1/Phimor[i-1])\n",
    "    \n",
    "    PberF.rescale_col(i, Phiber[i-1])\n",
    "    PberF.rescale_row(i, 1/Phiber[i-1])\n",
    "    \n",
    "    PbinF.rescale_col(i, Phibin[i-1])\n",
    "    PbinF.rescale_row(i, 1/Phibin[i-1])\n",
    "\n",
    "QmorF = identity_matrix(len(states)-2) - PmorF[1:-1,1:-1]\n",
    "QbinF = identity_matrix(len(states)-2) - PbinF[1:-1,1:-1]\n",
    "QberF = identity_matrix(len(states)-2) - PberF[1:-1,1:-1]\n",
    "    \n",
    "TimeBinF = QbinF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBinF = TimeBinF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBerF = QberF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBerF = TimeBerF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMorF = QmorF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMorF = TimeMorF.change_ring(SR).change_ring(F)\n",
    "\n",
    "#TimeMorNF = ((TimeMor - Phimor[0] * TimeMorF) / (1 - Phimor[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "5942ca13",
   "metadata": {},
   "outputs": [],
   "source": [
    "show(Pmor)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "b0ffb89d",
   "metadata": {},
   "outputs": [],
   "source": [
    "%%time\n",
    "N = 4\n",
    "\n",
    "states = list(it.product((0,1), range(N)))\n",
    "istates = { s:i for i,s in enumerate(states) }\n",
    "\n",
    "Pmor = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pbin = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pber = matrix(F, [[0]* len(states)] * len(states))\n",
    "\n",
    "Pmor[0,0] = Pbin[0,0] = Pber[0,0] = 1\n",
    "Pmor[len(states)-1, len(states)-1] = Pbin[len(states)-1, len(states)-1] = Pber[len(states)-1, len(states)-1] = 1\n",
    "\n",
    "for i in range(N):\n",
    "    # null center\n",
    "    if i:\n",
    "        Pmor[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i)\n",
    "        Pber[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "        Pbin[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "\n",
    "        Pmor[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) / i / (N-1)\n",
    "        Pber[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) / i / (N-1)\n",
    "        Pbin[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) / i / (N-1)\n",
    "        \n",
    "        Pmor[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pmor.row(istates[(0,i)]))\n",
    "        Pber[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pber.row(istates[(0,i)]))\n",
    "        Pbin[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pbin.row(istates[(0,i)]))\n",
    "        \n",
    "    \n",
    "    if i != N-1:\n",
    "        Pmor[istates[(1,i)],istates[(1,i+1)]] = r / (r*i + N-i) * (N-i) / (N-1)\n",
    "        Pber[istates[(1,i)],istates[(1,N-1)]] = r / (r*i + N-i) * p\n",
    "        for k in range(1,N-i):\n",
    "            Pbin[istates[(1,i)],istates[(1,i+k)]] = r / (r*i + N-i) * binomial(N-i, k) * p**k * (1-p)**(N-i - k)\n",
    "\n",
    "        Pmor[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*i + N-i)\n",
    "        Pber[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*i + N-i)\n",
    "        Pbin[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*i + N-i)\n",
    "        \n",
    "        Pmor[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pmor.row(istates[(0,i)]))\n",
    "        Pber[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pber.row(istates[(0,i)]))\n",
    "        Pbin[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pbin.row(istates[(0,i)]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way.. \n",
    "Pmor = Pmor.change_ring(SR).change_ring(F)\n",
    "Pber = Pber.change_ring(SR).change_ring(F)\n",
    "Pbin = Pbin.change_ring(SR).change_ring(F)\n",
    "\n",
    "Qmor = identity_matrix(len(states)-2) - Pmor[1:-1,1:-1]\n",
    "Qbin = identity_matrix(len(states)-2) - Pbin[1:-1,1:-1]\n",
    "Qber = identity_matrix(len(states)-2) - Pber[1:-1,1:-1]\n",
    "\n",
    "Phimor = Qmor.solve_right(vector(Pmor[1:-1,-1]))\n",
    "Phibin = Qbin.solve_right(vector(Pbin[1:-1,-1]))\n",
    "Phiber = Qber.solve_right(vector(Pber[1:-1,-1]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way\n",
    "Phimor = Phimor.change_ring(SR).change_ring(F)\n",
    "Phibin = Phibin.change_ring(SR).change_ring(F)\n",
    "Phiber = Phiber.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBin = Qbin.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBin = TimeBin.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBer = Qber.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBer = TimeBer.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMor = Qmor.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMor = TimeMor.change_ring(SR).change_ring(F)\n",
    "\n",
    "# Conditionated times\n",
    "PmorF = copy(Pmor)\n",
    "PberF = copy(Pber)\n",
    "PbinF = copy(Pbin)\n",
    "\n",
    "for i in range(1,len(states)-1):\n",
    "    PmorF.rescale_col(i, Phimor[i-1])\n",
    "    PmorF.rescale_row(i, 1/Phimor[i-1])\n",
    "    \n",
    "    PberF.rescale_col(i, Phiber[i-1])\n",
    "    PberF.rescale_row(i, 1/Phiber[i-1])\n",
    "    \n",
    "    PbinF.rescale_col(i, Phibin[i-1])\n",
    "    PbinF.rescale_row(i, 1/Phibin[i-1])\n",
    "\n",
    "QmorF = identity_matrix(len(states)-2) - PmorF[1:-1,1:-1]\n",
    "QbinF = identity_matrix(len(states)-2) - PbinF[1:-1,1:-1]\n",
    "QberF = identity_matrix(len(states)-2) - PberF[1:-1,1:-1]\n",
    "    \n",
    "TimeBinF = QbinF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBinF = TimeBinF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBerF = QberF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBerF = TimeBerF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMorF = QmorF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMorF = TimeMorF.change_ring(SR).change_ring(F)\n",
    "\n",
    "#TimeMorNF = ((TimeMor - Phimor[0] * TimeMorF) / (1 - Phimor[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "a97c91df",
   "metadata": {},
   "outputs": [],
   "source": [
    "show(Pmor)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "9d5c1ffe",
   "metadata": {},
   "outputs": [],
   "source": [
    "show(Pmor)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "f53d4a2e",
   "metadata": {},
   "outputs": [],
   "source": [
    "MeanTimeBin = 1/N * TimeBin[istates[(1,0)]] + (N-1)/N * TimeBin[istates[(0,1)]]\n",
    "MeanTimeBer = 1/N * TimeBer[istates[(1,0)]] + (N-1)/N * TimeBer[istates[(0,1)]]\n",
    "MeanTimeMor = 1/N * TimeMor[istates[(1,0)]] + (N-1)/N * TimeMor[istates[(0,1)]]\n",
    "\n",
    "MeanTimeBinF = 1/N * TimeBinF[istates[(1,0)]] + (N-1)/N * TimeBinF[istates[(0,1)]]\n",
    "MeanTimeBerF = 1/N * TimeBerF[istates[(1,0)]] + (N-1)/N * TimeBerF[istates[(0,1)]]\n",
    "MeanTimeMorF = 1/N * TimeMorF[istates[(1,0)]] + (N-1)/N * TimeMorF[istates[(0,1)]]\n",
    "\n",
    "meanPhimor = 1/N * Phimor[istates[(1,0)]] + (N-1)/N * Phimor[istates[(0,1)]]\n",
    "MeanTimeMorNF = ((MeanTimeMor - meanPhimor * MeanTimeMorF) / (1 - meanPhimor))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "meanPhibin = 1/N * Phibin[istates[(1,0)]] + (N-1)/N * Phibin[istates[(0,1)]]\n",
    "MeanTimeBinNF = ((MeanTimeBin - meanPhibin * MeanTimeBinF) / (1 - meanPhibin))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "meanPhiber = 1/N * Phiber[istates[(1,0)]] + (N-1)/N * Phiber[istates[(0,1)]]\n",
    "MeanTimeBerNF = ((MeanTimeBer - meanPhiber * MeanTimeBerF) / (1 - meanPhiber))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "                 #TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "56d6dda9",
   "metadata": {},
   "outputs": [],
   "source": [
    "maxr = 2\n",
    "plot3d((MeanTimeBinF), (r,0,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d((MeanTimeMorF), (r,0,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d((MeanTimeBerF), (r,0,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "10056118",
   "metadata": {},
   "outputs": [],
   "source": [
    "maxr = 2\n",
    "plot3d(log(MeanTimeBinF), (r,0,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMorF), (r,0,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBerF), (r,0,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "48c46f51",
   "metadata": {},
   "outputs": [],
   "source": [
    "plot3d(MeanTimeBinNF, (r,0,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(MeanTimeMorNF, (r,0,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(MeanTimeBerNF, (r,0,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "be9cc0e4",
   "metadata": {},
   "outputs": [],
   "source": [
    "plot3d(log(MeanTimeBinNF), (r,0,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMorNF), (r,0,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBerNF), (r,0,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "9774f5cd",
   "metadata": {},
   "outputs": [],
   "source": [
    "plot3d(log(MeanTimeBin), (r,0,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMor), (r,0,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBer), (r,0,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "9e82b320",
   "metadata": {},
   "outputs": [],
   "source": [
    "maxr = 2\n",
    "plot3d(log(MeanTimeBinF), (r,1,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMorF), (r,1,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBerF), (r,1,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "4443c1a1",
   "metadata": {},
   "outputs": [],
   "source": [
    "maxr = 4\n",
    "plot3d(log(MeanTimeBinF), (r,1,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMorF), (r,1,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBerF), (r,1,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "id": "afd090d4",
   "metadata": {},
   "outputs": [],
   "source": [
    "%%time\n",
    "N = 4\n",
    "\n",
    "states = list(it.product((0,1), range(N)))\n",
    "istates = { s:i for i,s in enumerate(states) }\n",
    "\n",
    "Pmor = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pbin = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pber = matrix(F, [[0]* len(states)] * len(states))\n",
    "\n",
    "Pmor[0,0] = Pbin[0,0] = Pber[0,0] = 1\n",
    "Pmor[len(states)-1, len(states)-1] = Pbin[len(states)-1, len(states)-1] = Pber[len(states)-1, len(states)-1] = 1\n",
    "\n",
    "for i in range(N):\n",
    "    # null center\n",
    "    if i !=0:\n",
    "        Pmor[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i)\n",
    "        Pber[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "        Pbin[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "\n",
    "        Pmor[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) / i / (N-1)\n",
    "        Pber[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) / i / (N-1)\n",
    "        Pbin[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) / i / (N-1)\n",
    "        \n",
    "        Pmor[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pmor.row(istates[(0,i)]))\n",
    "        Pber[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pber.row(istates[(0,i)]))\n",
    "        Pbin[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pbin.row(istates[(0,i)]))\n",
    "        \n",
    "    \n",
    "    if i != N-1:\n",
    "        Pmor[istates[(1,i)],istates[(1,i+1)]] = r / (r*i + N-i) * (N-i) / (N-1)\n",
    "        Pber[istates[(1,i)],istates[(1,N-1)]] = r / (r*i + N-i) * p\n",
    "        for k in range(1,N-i):\n",
    "            Pbin[istates[(1,i)],istates[(1,i+k)]] = r / (r*i + N-i) * binomial(N-i, k) * p**k * (1-p)**(N-i - k)\n",
    "\n",
    "        Pmor[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*i + N-i)\n",
    "        Pber[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*i + N-i)\n",
    "        Pbin[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*i + N-i)\n",
    "        \n",
    "        Pmor[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pmor.row(istates[(0,i)]))\n",
    "        Pber[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pber.row(istates[(0,i)]))\n",
    "        Pbin[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pbin.row(istates[(0,i)]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way.. \n",
    "Pmor = Pmor.change_ring(SR).change_ring(F)\n",
    "Pber = Pber.change_ring(SR).change_ring(F)\n",
    "Pbin = Pbin.change_ring(SR).change_ring(F)\n",
    "\n",
    "Qmor = identity_matrix(len(states)-2) - Pmor[1:-1,1:-1]\n",
    "Qbin = identity_matrix(len(states)-2) - Pbin[1:-1,1:-1]\n",
    "Qber = identity_matrix(len(states)-2) - Pber[1:-1,1:-1]\n",
    "\n",
    "Phimor = Qmor.solve_right(vector(Pmor[1:-1,-1]))\n",
    "Phibin = Qbin.solve_right(vector(Pbin[1:-1,-1]))\n",
    "Phiber = Qber.solve_right(vector(Pber[1:-1,-1]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way\n",
    "Phimor = Phimor.change_ring(SR).change_ring(F)\n",
    "Phibin = Phibin.change_ring(SR).change_ring(F)\n",
    "Phiber = Phiber.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBin = Qbin.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBin = TimeBin.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBer = Qber.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBer = TimeBer.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMor = Qmor.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMor = TimeMor.change_ring(SR).change_ring(F)\n",
    "\n",
    "# Conditionated times\n",
    "PmorF = copy(Pmor)\n",
    "PberF = copy(Pber)\n",
    "PbinF = copy(Pbin)\n",
    "\n",
    "for i in range(1,len(states)-1):\n",
    "    PmorF.rescale_col(i, Phimor[i-1])\n",
    "    PmorF.rescale_row(i, 1/Phimor[i-1])\n",
    "    \n",
    "    PberF.rescale_col(i, Phiber[i-1])\n",
    "    PberF.rescale_row(i, 1/Phiber[i-1])\n",
    "    \n",
    "    PbinF.rescale_col(i, Phibin[i-1])\n",
    "    PbinF.rescale_row(i, 1/Phibin[i-1])\n",
    "\n",
    "QmorF = identity_matrix(len(states)-2) - PmorF[1:-1,1:-1]\n",
    "QbinF = identity_matrix(len(states)-2) - PbinF[1:-1,1:-1]\n",
    "QberF = identity_matrix(len(states)-2) - PberF[1:-1,1:-1]\n",
    "    \n",
    "TimeBinF = QbinF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBinF = TimeBinF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBerF = QberF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBerF = TimeBerF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMorF = QmorF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMorF = TimeMorF.change_ring(SR).change_ring(F)\n",
    "\n",
    "#TimeMorNF = ((TimeMor - Phimor[0] * TimeMorF) / (1 - Phimor[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "id": "e0366a01",
   "metadata": {},
   "outputs": [],
   "source": [
    "show(Pmor)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 19,
   "id": "ece5c8e6",
   "metadata": {},
   "outputs": [],
   "source": [
    "%%time\n",
    "N = 4\n",
    "\n",
    "states = list(it.product((0,1), range(N)))\n",
    "istates = { s:i for i,s in enumerate(states) }\n",
    "\n",
    "Pmor = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pbin = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pber = matrix(F, [[0]* len(states)] * len(states))\n",
    "\n",
    "Pmor[0,0] = Pbin[0,0] = Pber[0,0] = 1\n",
    "Pmor[len(states)-1, len(states)-1] = Pbin[len(states)-1, len(states)-1] = Pber[len(states)-1, len(states)-1] = 1\n",
    "\n",
    "for i in range(N):\n",
    "    # null center\n",
    "    if i !=0:\n",
    "        Pmor[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i)\n",
    "        Pber[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "        Pbin[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "\n",
    "        Pmor[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) / i / (N-1)\n",
    "        Pber[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) / i / (N-1)\n",
    "        Pbin[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) / i / (N-1)\n",
    "        \n",
    "        Pmor[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pmor.row(istates[(0,i)]))\n",
    "        Pber[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pber.row(istates[(0,i)]))\n",
    "        Pbin[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pbin.row(istates[(0,i)]))\n",
    "        \n",
    "    \n",
    "    if i != N-1:\n",
    "        Pmor[istates[(1,i)],istates[(1,i+1)]] = r / (r*i + N-i) * (N-i) / (N-1)\n",
    "        Pber[istates[(1,i)],istates[(1,N-1)]] = r / (r*i + N-i) * p\n",
    "        for k in range(1,N-i):\n",
    "            Pbin[istates[(1,i)],istates[(1,i+k)]] = r / (r*i + N-i) * binomial(N-i, k) * p**k * (1-p)**(N-i - k)\n",
    "\n",
    "        Pmor[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*i + N-i)\n",
    "        Pber[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*i + N-i)\n",
    "        Pbin[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*i + N-i)\n",
    "        \n",
    "        Pmor[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pmor.row(istates[(0,i)]))\n",
    "        Pber[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pber.row(istates[(0,i)]))\n",
    "        Pbin[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pbin.row(istates[(0,i)]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way.. \n",
    "Pmor = Pmor.change_ring(SR).change_ring(F)\n",
    "Pber = Pber.change_ring(SR).change_ring(F)\n",
    "Pbin = Pbin.change_ring(SR).change_ring(F)\n",
    "\n",
    "Qmor = identity_matrix(len(states)-2) - Pmor[1:-1,1:-1]\n",
    "Qbin = identity_matrix(len(states)-2) - Pbin[1:-1,1:-1]\n",
    "Qber = identity_matrix(len(states)-2) - Pber[1:-1,1:-1]\n",
    "\n",
    "Phimor = Qmor.solve_right(vector(Pmor[1:-1,-1]))\n",
    "Phibin = Qbin.solve_right(vector(Pbin[1:-1,-1]))\n",
    "Phiber = Qber.solve_right(vector(Pber[1:-1,-1]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way\n",
    "Phimor = Phimor.change_ring(SR).change_ring(F)\n",
    "Phibin = Phibin.change_ring(SR).change_ring(F)\n",
    "Phiber = Phiber.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBin = Qbin.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBin = TimeBin.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBer = Qber.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBer = TimeBer.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMor = Qmor.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMor = TimeMor.change_ring(SR).change_ring(F)\n",
    "\n",
    "# Conditionated times\n",
    "PmorF = copy(Pmor)\n",
    "PberF = copy(Pber)\n",
    "PbinF = copy(Pbin)\n",
    "\n",
    "for i in range(1,len(states)-1):\n",
    "    PmorF.rescale_col(i, Phimor[i-1])\n",
    "    PmorF.rescale_row(i, 1/Phimor[i-1])\n",
    "    \n",
    "    PberF.rescale_col(i, Phiber[i-1])\n",
    "    PberF.rescale_row(i, 1/Phiber[i-1])\n",
    "    \n",
    "    PbinF.rescale_col(i, Phibin[i-1])\n",
    "    PbinF.rescale_row(i, 1/Phibin[i-1])\n",
    "\n",
    "QmorF = identity_matrix(len(states)-2) - PmorF[1:-1,1:-1]\n",
    "QbinF = identity_matrix(len(states)-2) - PbinF[1:-1,1:-1]\n",
    "QberF = identity_matrix(len(states)-2) - PberF[1:-1,1:-1]\n",
    "    \n",
    "TimeBinF = QbinF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBinF = TimeBinF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBerF = QberF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBerF = TimeBerF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMorF = QmorF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMorF = TimeMorF.change_ring(SR).change_ring(F)\n",
    "\n",
    "#TimeMorNF = ((TimeMor - Phimor[0] * TimeMorF) / (1 - Phimor[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "id": "044c4c72",
   "metadata": {},
   "outputs": [],
   "source": [
    "show(Pmor)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 21,
   "id": "cce2b91c",
   "metadata": {},
   "outputs": [],
   "source": [
    "%%time\n",
    "N = 4\n",
    "\n",
    "states = list(it.product((0,1), range(N)))\n",
    "istates = { s:i for i,s in enumerate(states) }\n",
    "\n",
    "Pmor = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pbin = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pber = matrix(F, [[0]* len(states)] * len(states))\n",
    "\n",
    "Pmor[0,0] = Pbin[0,0] = Pber[0,0] = 1\n",
    "Pmor[len(states)-1, len(states)-1] = Pbin[len(states)-1, len(states)-1] = Pber[len(states)-1, len(states)-1] = 1\n",
    "\n",
    "for i in range(N):\n",
    "    # null center\n",
    "    if i !=0:\n",
    "        Pmor[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i)\n",
    "        Pber[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "        Pbin[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "\n",
    "        Pmor[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pber[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pbin[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        \n",
    "        Pmor[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pmor.row(istates[(0,i)]))\n",
    "        Pber[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pber.row(istates[(0,i)]))\n",
    "        Pbin[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pbin.row(istates[(0,i)]))\n",
    "        \n",
    "    \n",
    "    if i != N-1:\n",
    "        Pmor[istates[(1,i)],istates[(1,i+1)]] = r / (r*i + N-i) * (N-i) / (N-1)\n",
    "        Pber[istates[(1,i)],istates[(1,N-1)]] = r / (r*i + N-i) * p\n",
    "        for k in range(1,N-i):\n",
    "            Pbin[istates[(1,i)],istates[(1,i+k)]] = r / (r*i + N-i) * binomial(N-i, k) * p**k * (1-p)**(N-i - k)\n",
    "\n",
    "        Pmor[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*i + N-i)\n",
    "        Pber[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*i + N-i)\n",
    "        Pbin[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*i + N-i)\n",
    "        \n",
    "        Pmor[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pmor.row(istates[(0,i)]))\n",
    "        Pber[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pber.row(istates[(0,i)]))\n",
    "        Pbin[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pbin.row(istates[(0,i)]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way.. \n",
    "Pmor = Pmor.change_ring(SR).change_ring(F)\n",
    "Pber = Pber.change_ring(SR).change_ring(F)\n",
    "Pbin = Pbin.change_ring(SR).change_ring(F)\n",
    "\n",
    "Qmor = identity_matrix(len(states)-2) - Pmor[1:-1,1:-1]\n",
    "Qbin = identity_matrix(len(states)-2) - Pbin[1:-1,1:-1]\n",
    "Qber = identity_matrix(len(states)-2) - Pber[1:-1,1:-1]\n",
    "\n",
    "Phimor = Qmor.solve_right(vector(Pmor[1:-1,-1]))\n",
    "Phibin = Qbin.solve_right(vector(Pbin[1:-1,-1]))\n",
    "Phiber = Qber.solve_right(vector(Pber[1:-1,-1]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way\n",
    "Phimor = Phimor.change_ring(SR).change_ring(F)\n",
    "Phibin = Phibin.change_ring(SR).change_ring(F)\n",
    "Phiber = Phiber.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBin = Qbin.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBin = TimeBin.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBer = Qber.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBer = TimeBer.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMor = Qmor.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMor = TimeMor.change_ring(SR).change_ring(F)\n",
    "\n",
    "# Conditionated times\n",
    "PmorF = copy(Pmor)\n",
    "PberF = copy(Pber)\n",
    "PbinF = copy(Pbin)\n",
    "\n",
    "for i in range(1,len(states)-1):\n",
    "    PmorF.rescale_col(i, Phimor[i-1])\n",
    "    PmorF.rescale_row(i, 1/Phimor[i-1])\n",
    "    \n",
    "    PberF.rescale_col(i, Phiber[i-1])\n",
    "    PberF.rescale_row(i, 1/Phiber[i-1])\n",
    "    \n",
    "    PbinF.rescale_col(i, Phibin[i-1])\n",
    "    PbinF.rescale_row(i, 1/Phibin[i-1])\n",
    "\n",
    "QmorF = identity_matrix(len(states)-2) - PmorF[1:-1,1:-1]\n",
    "QbinF = identity_matrix(len(states)-2) - PbinF[1:-1,1:-1]\n",
    "QberF = identity_matrix(len(states)-2) - PberF[1:-1,1:-1]\n",
    "    \n",
    "TimeBinF = QbinF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBinF = TimeBinF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBerF = QberF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBerF = TimeBerF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMorF = QmorF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMorF = TimeMorF.change_ring(SR).change_ring(F)\n",
    "\n",
    "#TimeMorNF = ((TimeMor - Phimor[0] * TimeMorF) / (1 - Phimor[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 22,
   "id": "76b037f5",
   "metadata": {},
   "outputs": [],
   "source": [
    "show(Pmor)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 23,
   "id": "bbfce7e1",
   "metadata": {},
   "outputs": [],
   "source": [
    "show(Pmor)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 24,
   "id": "e2ce9e54",
   "metadata": {},
   "outputs": [],
   "source": [
    "MeanTimeBin = 1/N * TimeBin[istates[(1,0)]] + (N-1)/N * TimeBin[istates[(0,1)]]\n",
    "MeanTimeBer = 1/N * TimeBer[istates[(1,0)]] + (N-1)/N * TimeBer[istates[(0,1)]]\n",
    "MeanTimeMor = 1/N * TimeMor[istates[(1,0)]] + (N-1)/N * TimeMor[istates[(0,1)]]\n",
    "\n",
    "MeanTimeBinF = 1/N * TimeBinF[istates[(1,0)]] + (N-1)/N * TimeBinF[istates[(0,1)]]\n",
    "MeanTimeBerF = 1/N * TimeBerF[istates[(1,0)]] + (N-1)/N * TimeBerF[istates[(0,1)]]\n",
    "MeanTimeMorF = 1/N * TimeMorF[istates[(1,0)]] + (N-1)/N * TimeMorF[istates[(0,1)]]\n",
    "\n",
    "meanPhimor = 1/N * Phimor[istates[(1,0)]] + (N-1)/N * Phimor[istates[(0,1)]]\n",
    "MeanTimeMorNF = ((MeanTimeMor - meanPhimor * MeanTimeMorF) / (1 - meanPhimor))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "meanPhibin = 1/N * Phibin[istates[(1,0)]] + (N-1)/N * Phibin[istates[(0,1)]]\n",
    "MeanTimeBinNF = ((MeanTimeBin - meanPhibin * MeanTimeBinF) / (1 - meanPhibin))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "meanPhiber = 1/N * Phiber[istates[(1,0)]] + (N-1)/N * Phiber[istates[(0,1)]]\n",
    "MeanTimeBerNF = ((MeanTimeBer - meanPhiber * MeanTimeBerF) / (1 - meanPhiber))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "                 #TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 25,
   "id": "3d07ebee",
   "metadata": {},
   "outputs": [],
   "source": [
    "maxr = 4\n",
    "plot3d(log(MeanTimeBinF), (r,1,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMorF), (r,1,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBerF), (r,1,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 26,
   "id": "725e67e1",
   "metadata": {},
   "outputs": [],
   "source": [
    "plot3d(log(MeanTimeBinNF), (r,0,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMorNF), (r,0,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBerNF), (r,0,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 27,
   "id": "c75ffd31",
   "metadata": {},
   "outputs": [],
   "source": [
    "istates"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 28,
   "id": "e65ca6e7",
   "metadata": {},
   "outputs": [],
   "source": [
    "show(Pmor)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 29,
   "id": "dbaea175",
   "metadata": {},
   "outputs": [],
   "source": [
    "MeanTimeBin = 1/N * TimeBin[istates[(1,0)]] + (N-1)/N * TimeBin[istates[(0,1)]]\n",
    "MeanTimeBer = 1/N * TimeBer[istates[(1,0)]] + (N-1)/N * TimeBer[istates[(0,1)]]\n",
    "MeanTimeMor = 1/N * TimeMor[istates[(1,0)]] + (N-1)/N * TimeMor[istates[(0,1)]]\n",
    "\n",
    "MeanTimeBinF = 1/N * TimeBinF[istates[(1,0)]] + (N-1)/N * TimeBinF[istates[(0,1)]]\n",
    "MeanTimeBerF = 1/N * TimeBerF[istates[(1,0)]] + (N-1)/N * TimeBerF[istates[(0,1)]]\n",
    "MeanTimeMorF = 1/N * TimeMorF[istates[(1,0)]] + (N-1)/N * TimeMorF[istates[(0,1)]]\n",
    "\n",
    "meanPhimor = 1/N * Phimor[istates[(1,0)]] + (N-1)/N * Phimor[istates[(0,1)]]\n",
    "MeanTimeMorNF = ((MeanTimeMor - meanPhimor * MeanTimeMorF) / (1 - meanPhimor))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "meanPhibin = 1/N * Phibin[istates[(1,0)]] + (N-1)/N * Phibin[istates[(0,1)]]\n",
    "MeanTimeBinNF = ((MeanTimeBin - meanPhibin * MeanTimeBinF) / (1 - meanPhibin))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "meanPhiber = 1/N * Phiber[istates[(1,0)]] + (N-1)/N * Phiber[istates[(0,1)]]\n",
    "MeanTimeBerNF = ((MeanTimeBer - meanPhiber * MeanTimeBerF) / (1 - meanPhiber))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "                 #TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 30,
   "id": "661c0d74",
   "metadata": {},
   "outputs": [],
   "source": [
    "maxr = 4\n",
    "plot3d(log(MeanTimeBinF), (r,1,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMorF), (r,1,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBerF), (r,1,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 31,
   "id": "53ddc9e6",
   "metadata": {},
   "outputs": [],
   "source": [
    "plot3d(log(MeanTimeBinNF), (r,0,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMorNF), (r,0,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBerNF), (r,0,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 32,
   "id": "be22868d",
   "metadata": {},
   "outputs": [],
   "source": [
    "plot3d(log(MeanTimeBin), (r,0,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMor), (r,0,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBer), (r,0,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 33,
   "id": "08c71bd7",
   "metadata": {},
   "outputs": [],
   "source": [
    "def pc(f):\n",
    "    a = 0\n",
    "    sa = (f(p=a) > 0)\n",
    "    b = 1\n",
    "    while b-a > 1e-18:\n",
    "        c = (a+b)/2\n",
    "        sc = (f(p=c) > 0)\n",
    "        if sc ^ sa:\n",
    "            a = c\n",
    "        else:\n",
    "            b = c\n",
    "    \n",
    "    return n((b+a) / 2)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 34,
   "id": "c9946492",
   "metadata": {},
   "outputs": [],
   "source": [
    "rs = [0,1/80..2/10]\n",
    "rs.extend([2/10,2/10+1/40..1][1:-1])\n",
    "rs.extend([1,1+1/10..10])\n",
    "pcsbin = []\n",
    "pcsber = []\n",
    "tmpbin = (meanPhibin - meanPhimor)\n",
    "tmpber = (meanPhiber - meanPhimor)\n",
    "for valr in rs:\n",
    "    if valr == 0:\n",
    "        pcsbin.append(0)\n",
    "        pcsber.append(0)\n",
    "    else:\n",
    "        pcsbin.append(pc(tmpbin.numerator().subs(r=valr)))\n",
    "        pcsber.append(pc(tmpber.numerator().subs(r=valr)))\n",
    "    "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 35,
   "id": "06c51c08",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=0.5) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 36,
   "id": "0f8ab10c",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=0.53) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 37,
   "id": "5d9405de",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=0.54) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 38,
   "id": "b95f9ae9",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=0.8) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 39,
   "id": "12bc9d31",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=1) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 40,
   "id": "2a34ffb6",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=0) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 41,
   "id": "60b6235a",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=5) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 42,
   "id": "4294ba52",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=1) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 43,
   "id": "a5e41a2f",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=0.99) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 44,
   "id": "e63ef8a4",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, pcsbin)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 45,
   "id": "88794a66",
   "metadata": {},
   "outputs": [],
   "source": [
    "%%time\n",
    "N = 4\n",
    "\n",
    "states = list(it.product((0,1), range(N)))\n",
    "istates = { s:i for i,s in enumerate(states) }\n",
    "\n",
    "Pmor = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pbin = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pber = matrix(F, [[0]* len(states)] * len(states))\n",
    "\n",
    "Pmor[0,0] = Pbin[0,0] = Pber[0,0] = 1\n",
    "Pmor[len(states)-1, len(states)-1] = Pbin[len(states)-1, len(states)-1] = Pber[len(states)-1, len(states)-1] = 1\n",
    "\n",
    "for i in range(N):\n",
    "    # null center\n",
    "    if i !=0:\n",
    "        Pmor[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i)\n",
    "        Pber[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "        Pbin[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "\n",
    "        Pmor[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pber[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pbin[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        \n",
    "        Pmor[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pmor.row(istates[(0,i)]))\n",
    "        Pber[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pber.row(istates[(0,i)]))\n",
    "        Pbin[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pbin.row(istates[(0,i)]))\n",
    "        \n",
    "    \n",
    "    if i != N-1:\n",
    "        Pmor[istates[(1,i)],istates[(1,i+1)]] = r / (r*i + N-i) * (N-i) / (N-1)\n",
    "        Pber[istates[(1,i)],istates[(1,N-1)]] = r / (r*i + N-i) * p\n",
    "        for k in range(1,N-i):\n",
    "            Pbin[istates[(1,i)],istates[(1,i+k)]] = r / (r*i + N-i) * binomial(N-i, k) * p**k * (1-p)**(N-i - k)\n",
    "\n",
    "        Pmor[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*i + N-i)\n",
    "        Pber[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*i + N-i)\n",
    "        Pbin[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*i + N-i)\n",
    "        \n",
    "        Pmor[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pmor.row(istates[(0,i)]))\n",
    "        Pber[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pber.row(istates[(0,i)]))\n",
    "        Pbin[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pbin.row(istates[(0,i)]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way.. \n",
    "Pmor = Pmor.change_ring(SR).change_ring(F)\n",
    "Pber = Pber.change_ring(SR).change_ring(F)\n",
    "Pbin = Pbin.change_ring(SR).change_ring(F)\n",
    "\n",
    "Qmor = identity_matrix(len(states)-2) - Pmor[1:-1,1:-1]\n",
    "Qbin = identity_matrix(len(states)-2) - Pbin[1:-1,1:-1]\n",
    "Qber = identity_matrix(len(states)-2) - Pber[1:-1,1:-1]\n",
    "\n",
    "Phimor = Qmor.solve_right(vector(Pmor[1:-1,-1]))\n",
    "Phibin = Qbin.solve_right(vector(Pbin[1:-1,-1]))\n",
    "Phiber = Qber.solve_right(vector(Pber[1:-1,-1]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way\n",
    "Phimor = Phimor.change_ring(SR).change_ring(F)\n",
    "Phibin = Phibin.change_ring(SR).change_ring(F)\n",
    "Phiber = Phiber.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBin = Qbin.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBin = TimeBin.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBer = Qber.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBer = TimeBer.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMor = Qmor.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMor = TimeMor.change_ring(SR).change_ring(F)\n",
    "\n",
    "# Conditionated times\n",
    "PmorF = copy(Pmor)\n",
    "PberF = copy(Pber)\n",
    "PbinF = copy(Pbin)\n",
    "\n",
    "for i in range(1,len(states)-1):\n",
    "    PmorF.rescale_col(i, Phimor[i-1])\n",
    "    PmorF.rescale_row(i, 1/Phimor[i-1])\n",
    "    \n",
    "    PberF.rescale_col(i, Phiber[i-1])\n",
    "    PberF.rescale_row(i, 1/Phiber[i-1])\n",
    "    \n",
    "    PbinF.rescale_col(i, Phibin[i-1])\n",
    "    PbinF.rescale_row(i, 1/Phibin[i-1])\n",
    "\n",
    "QmorF = identity_matrix(len(states)-2) - PmorF[1:-1,1:-1]\n",
    "QbinF = identity_matrix(len(states)-2) - PbinF[1:-1,1:-1]\n",
    "QberF = identity_matrix(len(states)-2) - PberF[1:-1,1:-1]\n",
    "    \n",
    "TimeBinF = QbinF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBinF = TimeBinF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBerF = QberF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBerF = TimeBerF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMorF = QmorF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMorF = TimeMorF.change_ring(SR).change_ring(F)\n",
    "\n",
    "#TimeMorNF = ((TimeMor - Phimor[0] * TimeMorF) / (1 - Phimor[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 46,
   "id": "bd8cb112",
   "metadata": {},
   "outputs": [],
   "source": [
    "phimor[0]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 47,
   "id": "7121aebc",
   "metadata": {},
   "outputs": [],
   "source": [
    "Phimor[0]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 48,
   "id": "d61feb7e",
   "metadata": {},
   "outputs": [],
   "source": [
    "Phimor[istates[(1,0)]]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 49,
   "id": "e315c2a7",
   "metadata": {},
   "outputs": [],
   "source": [
    "%%time\n",
    "N = 4\n",
    "\n",
    "states = list(it.product((0,1), range(N)))\n",
    "istates = { s:i for i,s in enumerate(states) }\n",
    "\n",
    "Pmor = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pbin = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pber = matrix(F, [[0]* len(states)] * len(states))\n",
    "\n",
    "Pmor[0,0] = Pbin[0,0] = Pber[0,0] = 1\n",
    "Pmor[len(states)-1, len(states)-1] = Pbin[len(states)-1, len(states)-1] = Pber[len(states)-1, len(states)-1] = 1\n",
    "\n",
    "for i in range(N):\n",
    "    # null center\n",
    "    if i != 0:\n",
    "        Pmor[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i)\n",
    "        Pber[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "        Pbin[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "\n",
    "        Pmor[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pber[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pbin[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        \n",
    "        Pmor[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pmor.row(istates[(0,i)]))\n",
    "        Pber[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pber.row(istates[(0,i)]))\n",
    "        Pbin[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pbin.row(istates[(0,i)]))\n",
    "        \n",
    "    \n",
    "    if i != N-1:\n",
    "        Pmor[istates[(1,i)],istates[(1,i+1)]] = r / (r*(i+1) + N-i-1) * (N-i) / (N-1)\n",
    "        Pber[istates[(1,i)],istates[(1,N-1)]] = r / (r*(i+1) + N-i-1) * p\n",
    "        for k in range(1,N-i):\n",
    "            Pbin[istates[(1,i)],istates[(1,i+k)]] = r / (r*(i+1) + N-i-1) * binomial(N-i, k) * p**k * (1-p)**(N-i - k)\n",
    "\n",
    "        Pmor[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*(i+1) + N-i-1)\n",
    "        Pber[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*(i+1) + N-i-1)\n",
    "        Pbin[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*(i+1) + N-i-1)\n",
    "        \n",
    "        Pmor[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pmor.row(istates[(0,i)]))\n",
    "        Pber[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pber.row(istates[(0,i)]))\n",
    "        Pbin[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pbin.row(istates[(0,i)]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way.. \n",
    "Pmor = Pmor.change_ring(SR).change_ring(F)\n",
    "Pber = Pber.change_ring(SR).change_ring(F)\n",
    "Pbin = Pbin.change_ring(SR).change_ring(F)\n",
    "\n",
    "Qmor = identity_matrix(len(states)-2) - Pmor[1:-1,1:-1]\n",
    "Qbin = identity_matrix(len(states)-2) - Pbin[1:-1,1:-1]\n",
    "Qber = identity_matrix(len(states)-2) - Pber[1:-1,1:-1]\n",
    "\n",
    "Phimor = Qmor.solve_right(vector(Pmor[1:-1,-1]))\n",
    "Phibin = Qbin.solve_right(vector(Pbin[1:-1,-1]))\n",
    "Phiber = Qber.solve_right(vector(Pber[1:-1,-1]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way\n",
    "Phimor = Phimor.change_ring(SR).change_ring(F)\n",
    "Phibin = Phibin.change_ring(SR).change_ring(F)\n",
    "Phiber = Phiber.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBin = Qbin.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBin = TimeBin.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBer = Qber.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBer = TimeBer.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMor = Qmor.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMor = TimeMor.change_ring(SR).change_ring(F)\n",
    "\n",
    "# Conditionated times\n",
    "PmorF = copy(Pmor)\n",
    "PberF = copy(Pber)\n",
    "PbinF = copy(Pbin)\n",
    "\n",
    "for i in range(1,len(states)-1):\n",
    "    PmorF.rescale_col(i, Phimor[i-1])\n",
    "    PmorF.rescale_row(i, 1/Phimor[i-1])\n",
    "    \n",
    "    PberF.rescale_col(i, Phiber[i-1])\n",
    "    PberF.rescale_row(i, 1/Phiber[i-1])\n",
    "    \n",
    "    PbinF.rescale_col(i, Phibin[i-1])\n",
    "    PbinF.rescale_row(i, 1/Phibin[i-1])\n",
    "\n",
    "QmorF = identity_matrix(len(states)-2) - PmorF[1:-1,1:-1]\n",
    "QbinF = identity_matrix(len(states)-2) - PbinF[1:-1,1:-1]\n",
    "QberF = identity_matrix(len(states)-2) - PberF[1:-1,1:-1]\n",
    "    \n",
    "TimeBinF = QbinF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBinF = TimeBinF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBerF = QberF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBerF = TimeBerF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMorF = QmorF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMorF = TimeMorF.change_ring(SR).change_ring(F)\n",
    "\n",
    "#TimeMorNF = ((TimeMor - Phimor[0] * TimeMorF) / (1 - Phimor[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 50,
   "id": "4e3c0e7b",
   "metadata": {},
   "outputs": [],
   "source": [
    "Phimor[istates[(1,0)]]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 51,
   "id": "1a99898f",
   "metadata": {},
   "outputs": [],
   "source": [
    "show(Pmor)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 52,
   "id": "fc0fdcbd",
   "metadata": {},
   "outputs": [],
   "source": [
    "%%time\n",
    "N = 4\n",
    "\n",
    "states = list(it.product((0,1), range(N)))\n",
    "istates = { s:i for i,s in enumerate(states) }\n",
    "\n",
    "Pmor = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pbin = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pber = matrix(F, [[0]* len(states)] * len(states))\n",
    "\n",
    "Pmor[0,0] = Pbin[0,0] = Pber[0,0] = 1\n",
    "Pmor[len(states)-1, len(states)-1] = Pbin[len(states)-1, len(states)-1] = Pber[len(states)-1, len(states)-1] = 1\n",
    "\n",
    "for i in range(N):\n",
    "    # null center\n",
    "    if i != 0:\n",
    "        Pmor[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i)\n",
    "        Pber[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "        Pbin[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "\n",
    "        Pmor[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pber[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pbin[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        \n",
    "        Pmor[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pmor.row(istates[(0,i)]))\n",
    "        Pber[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pber.row(istates[(0,i)]))\n",
    "        Pbin[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pbin.row(istates[(0,i)]))\n",
    "        \n",
    "    \n",
    "    if i != N-1:\n",
    "        Pmor[istates[(1,i)],istates[(1,i+1)]] = r / (r*(i+1) + N-i-1) * (N-i) / (N-1)\n",
    "        Pber[istates[(1,i)],istates[(1,N-1)]] = r / (r*(i+1) + N-i-1) * p\n",
    "        for k in range(1,N-i):\n",
    "            Pbin[istates[(1,i)],istates[(1,i+k)]] = r / (r*(i+1) + N-i-1) * binomial(N-i, k) * p**k * (1-p)**(N-i - k)\n",
    "\n",
    "        Pmor[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*(i+1) + N-i-1)\n",
    "        Pber[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*(i+1) + N-i-1)\n",
    "        Pbin[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*(i+1) + N-i-1)\n",
    "        \n",
    "        Pmor[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pmor.row(istates[(1,i)]))\n",
    "        Pber[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pber.row(istates[(1,i)]))\n",
    "        Pbin[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pbin.row(istates[(1,i)]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way.. \n",
    "Pmor = Pmor.change_ring(SR).change_ring(F)\n",
    "Pber = Pber.change_ring(SR).change_ring(F)\n",
    "Pbin = Pbin.change_ring(SR).change_ring(F)\n",
    "\n",
    "Qmor = identity_matrix(len(states)-2) - Pmor[1:-1,1:-1]\n",
    "Qbin = identity_matrix(len(states)-2) - Pbin[1:-1,1:-1]\n",
    "Qber = identity_matrix(len(states)-2) - Pber[1:-1,1:-1]\n",
    "\n",
    "Phimor = Qmor.solve_right(vector(Pmor[1:-1,-1]))\n",
    "Phibin = Qbin.solve_right(vector(Pbin[1:-1,-1]))\n",
    "Phiber = Qber.solve_right(vector(Pber[1:-1,-1]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way\n",
    "Phimor = Phimor.change_ring(SR).change_ring(F)\n",
    "Phibin = Phibin.change_ring(SR).change_ring(F)\n",
    "Phiber = Phiber.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBin = Qbin.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBin = TimeBin.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBer = Qber.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBer = TimeBer.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMor = Qmor.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMor = TimeMor.change_ring(SR).change_ring(F)\n",
    "\n",
    "# Conditionated times\n",
    "PmorF = copy(Pmor)\n",
    "PberF = copy(Pber)\n",
    "PbinF = copy(Pbin)\n",
    "\n",
    "for i in range(1,len(states)-1):\n",
    "    PmorF.rescale_col(i, Phimor[i-1])\n",
    "    PmorF.rescale_row(i, 1/Phimor[i-1])\n",
    "    \n",
    "    PberF.rescale_col(i, Phiber[i-1])\n",
    "    PberF.rescale_row(i, 1/Phiber[i-1])\n",
    "    \n",
    "    PbinF.rescale_col(i, Phibin[i-1])\n",
    "    PbinF.rescale_row(i, 1/Phibin[i-1])\n",
    "\n",
    "QmorF = identity_matrix(len(states)-2) - PmorF[1:-1,1:-1]\n",
    "QbinF = identity_matrix(len(states)-2) - PbinF[1:-1,1:-1]\n",
    "QberF = identity_matrix(len(states)-2) - PberF[1:-1,1:-1]\n",
    "    \n",
    "TimeBinF = QbinF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBinF = TimeBinF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBerF = QberF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBerF = TimeBerF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMorF = QmorF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMorF = TimeMorF.change_ring(SR).change_ring(F)\n",
    "\n",
    "#TimeMorNF = ((TimeMor - Phimor[0] * TimeMorF) / (1 - Phimor[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 53,
   "id": "02cc4851",
   "metadata": {},
   "outputs": [],
   "source": [
    "Phimor[istates[(1,0)]]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 54,
   "id": "c7308857",
   "metadata": {},
   "outputs": [],
   "source": [
    "show(Pmor)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 55,
   "id": "c541f1dd",
   "metadata": {},
   "outputs": [],
   "source": [
    "MeanTimeBin = 1/N * TimeBin[istates[(1,0)]] + (N-1)/N * TimeBin[istates[(0,1)]]\n",
    "MeanTimeBer = 1/N * TimeBer[istates[(1,0)]] + (N-1)/N * TimeBer[istates[(0,1)]]\n",
    "MeanTimeMor = 1/N * TimeMor[istates[(1,0)]] + (N-1)/N * TimeMor[istates[(0,1)]]\n",
    "\n",
    "MeanTimeBinF = 1/N * TimeBinF[istates[(1,0)]] + (N-1)/N * TimeBinF[istates[(0,1)]]\n",
    "MeanTimeBerF = 1/N * TimeBerF[istates[(1,0)]] + (N-1)/N * TimeBerF[istates[(0,1)]]\n",
    "MeanTimeMorF = 1/N * TimeMorF[istates[(1,0)]] + (N-1)/N * TimeMorF[istates[(0,1)]]\n",
    "\n",
    "meanPhimor = 1/N * Phimor[istates[(1,0)]] + (N-1)/N * Phimor[istates[(0,1)]]\n",
    "MeanTimeMorNF = ((MeanTimeMor - meanPhimor * MeanTimeMorF) / (1 - meanPhimor))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "meanPhibin = 1/N * Phibin[istates[(1,0)]] + (N-1)/N * Phibin[istates[(0,1)]]\n",
    "MeanTimeBinNF = ((MeanTimeBin - meanPhibin * MeanTimeBinF) / (1 - meanPhibin))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "meanPhiber = 1/N * Phiber[istates[(1,0)]] + (N-1)/N * Phiber[istates[(0,1)]]\n",
    "MeanTimeBerNF = ((MeanTimeBer - meanPhiber * MeanTimeBerF) / (1 - meanPhiber))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "                 #TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 56,
   "id": "8b17c34d",
   "metadata": {},
   "outputs": [],
   "source": [
    "maxr = 4\n",
    "plot3d(log(MeanTimeBinF), (r,1,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMorF), (r,1,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBerF), (r,1,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 57,
   "id": "58963e69",
   "metadata": {},
   "outputs": [],
   "source": [
    "plot3d(log(MeanTimeBinNF), (r,0,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMorNF), (r,0,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBerNF), (r,0,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 58,
   "id": "673fb870",
   "metadata": {},
   "outputs": [],
   "source": [
    "plot3d(log(MeanTimeBin), (r,0,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMor), (r,0,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBer), (r,0,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 59,
   "id": "95b342bd",
   "metadata": {},
   "outputs": [],
   "source": [
    "def pc(f):\n",
    "    a = 0\n",
    "    sa = (f(p=a) > 0)\n",
    "    b = 1\n",
    "    while b-a > 1e-18:\n",
    "        c = (a+b)/2\n",
    "        sc = (f(p=c) > 0)\n",
    "        if sc ^ sa:\n",
    "            a = c\n",
    "        else:\n",
    "            b = c\n",
    "    \n",
    "    return n((b+a) / 2)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 60,
   "id": "26d6194c",
   "metadata": {},
   "outputs": [],
   "source": [
    "rs = [0,1/80..2/10]\n",
    "rs.extend([2/10,2/10+1/40..1][1:-1])\n",
    "rs.extend([1,1+1/10..10])\n",
    "pcsbin = []\n",
    "pcsber = []\n",
    "tmpbin = (meanPhibin - meanPhimor)\n",
    "tmpber = (meanPhiber - meanPhimor)\n",
    "for valr in rs:\n",
    "    if valr == 0:\n",
    "        pcsbin.append(0)\n",
    "        pcsber.append(0)\n",
    "    else:\n",
    "        pcsbin.append(pc(tmpbin.numerator().subs(r=valr)))\n",
    "        pcsber.append(pc(tmpber.numerator().subs(r=valr)))\n",
    "    "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 61,
   "id": "45ab377e",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=0.99) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 62,
   "id": "55f18fd9",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=1) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 63,
   "id": "eccba7f8",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhiber(r=v,p=1) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 64,
   "id": "27a0747f",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=1) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 65,
   "id": "22c6a7e9",
   "metadata": {},
   "outputs": [],
   "source": [
    "%%time\n",
    "N = 4\n",
    "\n",
    "states = list(it.product((0,1), range(N)))\n",
    "istates = { s:i for i,s in enumerate(states) }\n",
    "\n",
    "Pmor = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pbin = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pber = matrix(F, [[0]* len(states)] * len(states))\n",
    "\n",
    "Pmor[0,0] = Pbin[0,0] = Pber[0,0] = 1\n",
    "Pmor[len(states)-1, len(states)-1] = Pbin[len(states)-1, len(states)-1] = Pber[len(states)-1, len(states)-1] = 1\n",
    "\n",
    "for i in range(N):\n",
    "    # null center\n",
    "    if i != 0:\n",
    "        Pmor[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i)\n",
    "        Pber[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "        Pbin[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "\n",
    "        Pmor[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pber[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pbin[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        \n",
    "        Pmor[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pmor.row(istates[(0,i)]))\n",
    "        Pber[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pber.row(istates[(0,i)]))\n",
    "        Pbin[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pbin.row(istates[(0,i)]))\n",
    "        \n",
    "    \n",
    "    if i != N-1:\n",
    "        Pmor[istates[(1,i)],istates[(1,i+1)]] = r / (r*(i+1) + N-i-1) * (N-i-1) / (N-1)\n",
    "        Pber[istates[(1,i)],istates[(1,N-1)]] = r / (r*(i+1) + N-i-1) * p\n",
    "        for k in range(1,N-i):\n",
    "            Pbin[istates[(1,i)],istates[(1,i+k)]] = r / (r*(i+1) + N-i-1) * binomial(N-i, k) * p**k * (1-p)**(N-i - k)\n",
    "\n",
    "        Pmor[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*(i+1) + N-i-1)\n",
    "        Pber[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*(i+1) + N-i-1)\n",
    "        Pbin[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*(i+1) + N-i-1)\n",
    "        \n",
    "        Pmor[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pmor.row(istates[(1,i)]))\n",
    "        Pber[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pber.row(istates[(1,i)]))\n",
    "        Pbin[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pbin.row(istates[(1,i)]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way.. \n",
    "Pmor = Pmor.change_ring(SR).change_ring(F)\n",
    "Pber = Pber.change_ring(SR).change_ring(F)\n",
    "Pbin = Pbin.change_ring(SR).change_ring(F)\n",
    "\n",
    "Qmor = identity_matrix(len(states)-2) - Pmor[1:-1,1:-1]\n",
    "Qbin = identity_matrix(len(states)-2) - Pbin[1:-1,1:-1]\n",
    "Qber = identity_matrix(len(states)-2) - Pber[1:-1,1:-1]\n",
    "\n",
    "Phimor = Qmor.solve_right(vector(Pmor[1:-1,-1]))\n",
    "Phibin = Qbin.solve_right(vector(Pbin[1:-1,-1]))\n",
    "Phiber = Qber.solve_right(vector(Pber[1:-1,-1]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way\n",
    "Phimor = Phimor.change_ring(SR).change_ring(F)\n",
    "Phibin = Phibin.change_ring(SR).change_ring(F)\n",
    "Phiber = Phiber.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBin = Qbin.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBin = TimeBin.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBer = Qber.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBer = TimeBer.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMor = Qmor.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMor = TimeMor.change_ring(SR).change_ring(F)\n",
    "\n",
    "# Conditionated times\n",
    "PmorF = copy(Pmor)\n",
    "PberF = copy(Pber)\n",
    "PbinF = copy(Pbin)\n",
    "\n",
    "for i in range(1,len(states)-1):\n",
    "    PmorF.rescale_col(i, Phimor[i-1])\n",
    "    PmorF.rescale_row(i, 1/Phimor[i-1])\n",
    "    \n",
    "    PberF.rescale_col(i, Phiber[i-1])\n",
    "    PberF.rescale_row(i, 1/Phiber[i-1])\n",
    "    \n",
    "    PbinF.rescale_col(i, Phibin[i-1])\n",
    "    PbinF.rescale_row(i, 1/Phibin[i-1])\n",
    "\n",
    "QmorF = identity_matrix(len(states)-2) - PmorF[1:-1,1:-1]\n",
    "QbinF = identity_matrix(len(states)-2) - PbinF[1:-1,1:-1]\n",
    "QberF = identity_matrix(len(states)-2) - PberF[1:-1,1:-1]\n",
    "    \n",
    "TimeBinF = QbinF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBinF = TimeBinF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBerF = QberF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBerF = TimeBerF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMorF = QmorF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMorF = TimeMorF.change_ring(SR).change_ring(F)\n",
    "\n",
    "#TimeMorNF = ((TimeMor - Phimor[0] * TimeMorF) / (1 - Phimor[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 66,
   "id": "e1bcca6f",
   "metadata": {},
   "outputs": [],
   "source": [
    "show(Pmor)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 67,
   "id": "f9ce5e5a",
   "metadata": {},
   "outputs": [],
   "source": [
    "%%time\n",
    "N = 4\n",
    "\n",
    "states = list(it.product((0,1), range(N)))\n",
    "istates = { s:i for i,s in enumerate(states) }\n",
    "\n",
    "Pmor = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pbin = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pber = matrix(F, [[0]* len(states)] * len(states))\n",
    "\n",
    "Pmor[0,0] = Pbin[0,0] = Pber[0,0] = 1\n",
    "Pmor[len(states)-1, len(states)-1] = Pbin[len(states)-1, len(states)-1] = Pber[len(states)-1, len(states)-1] = 1\n",
    "\n",
    "for i in range(N):\n",
    "    # null center\n",
    "    if i != 0:\n",
    "        Pmor[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i)\n",
    "        Pber[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "        Pbin[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "\n",
    "        Pmor[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pber[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pbin[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        \n",
    "        Pmor[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pmor.row(istates[(0,i)]))\n",
    "        Pber[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pber.row(istates[(0,i)]))\n",
    "        Pbin[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pbin.row(istates[(0,i)]))\n",
    "        \n",
    "    \n",
    "    if i != N-1:\n",
    "        Pmor[istates[(1,i)],istates[(1,i+1)]] = r / (r*(i+1) + N-i-1) * (N-i-1) / (N-1)\n",
    "        Pber[istates[(1,i)],istates[(1,N-1)]] = r / (r*(i+1) + N-i-1) * p\n",
    "        for k in range(1,N-i):\n",
    "            Pbin[istates[(1,i)],istates[(1,i+k)]] = r / (r*(i+1) + N-i-1) * binomial(N-i, k) * p**k * (1-p)**(N-i - k)\n",
    "\n",
    "        Pmor[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*(i+1) + N-i-1)\n",
    "        Pber[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*(i+1) + N-i-1)\n",
    "        Pbin[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*(i+1) + N-i-1)\n",
    "        \n",
    "        Pmor[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pmor.row(istates[(1,i)]))\n",
    "        Pber[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pber.row(istates[(1,i)]))\n",
    "        Pbin[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pbin.row(istates[(1,i)]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way.. \n",
    "Pmor = Pmor.change_ring(SR).change_ring(F)\n",
    "Pber = Pber.change_ring(SR).change_ring(F)\n",
    "Pbin = Pbin.change_ring(SR).change_ring(F)\n",
    "\n",
    "Qmor = identity_matrix(len(states)-2) - Pmor[1:-1,1:-1]\n",
    "Qbin = identity_matrix(len(states)-2) - Pbin[1:-1,1:-1]\n",
    "Qber = identity_matrix(len(states)-2) - Pber[1:-1,1:-1]\n",
    "\n",
    "Phimor = Qmor.solve_right(vector(Pmor[1:-1,-1]))\n",
    "Phibin = Qbin.solve_right(vector(Pbin[1:-1,-1]))\n",
    "Phiber = Qber.solve_right(vector(Pber[1:-1,-1]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way\n",
    "Phimor = Phimor.change_ring(SR).change_ring(F)\n",
    "Phibin = Phibin.change_ring(SR).change_ring(F)\n",
    "Phiber = Phiber.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBin = Qbin.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBin = TimeBin.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBer = Qber.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBer = TimeBer.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMor = Qmor.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMor = TimeMor.change_ring(SR).change_ring(F)\n",
    "\n",
    "# Conditionated times\n",
    "PmorF = copy(Pmor)\n",
    "PberF = copy(Pber)\n",
    "PbinF = copy(Pbin)\n",
    "\n",
    "for i in range(1,len(states)-1):\n",
    "    PmorF.rescale_col(i, Phimor[i-1])\n",
    "    PmorF.rescale_row(i, 1/Phimor[i-1])\n",
    "    \n",
    "    PberF.rescale_col(i, Phiber[i-1])\n",
    "    PberF.rescale_row(i, 1/Phiber[i-1])\n",
    "    \n",
    "    PbinF.rescale_col(i, Phibin[i-1])\n",
    "    PbinF.rescale_row(i, 1/Phibin[i-1])\n",
    "\n",
    "QmorF = identity_matrix(len(states)-2) - PmorF[1:-1,1:-1]\n",
    "QbinF = identity_matrix(len(states)-2) - PbinF[1:-1,1:-1]\n",
    "QberF = identity_matrix(len(states)-2) - PberF[1:-1,1:-1]\n",
    "    \n",
    "TimeBinF = QbinF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBinF = TimeBinF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBerF = QberF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBerF = TimeBerF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMorF = QmorF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMorF = TimeMorF.change_ring(SR).change_ring(F)\n",
    "\n",
    "#TimeMorNF = ((TimeMor - Phimor[0] * TimeMorF) / (1 - Phimor[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 68,
   "id": "24222189",
   "metadata": {},
   "outputs": [],
   "source": [
    "show(Pmor)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 69,
   "id": "216fb6b7",
   "metadata": {},
   "outputs": [],
   "source": [
    "%%time\n",
    "N = 4\n",
    "\n",
    "states = list(it.product((0,1), range(N)))\n",
    "istates = { s:i for i,s in enumerate(states) }\n",
    "\n",
    "Pmor = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pbin = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pber = matrix(F, [[0]* len(states)] * len(states))\n",
    "\n",
    "Pmor[0,0] = Pbin[0,0] = Pber[0,0] = 1\n",
    "Pmor[len(states)-1, len(states)-1] = Pbin[len(states)-1, len(states)-1] = Pber[len(states)-1, len(states)-1] = 1\n",
    "\n",
    "for i in range(N):\n",
    "    # null center\n",
    "    if i != 0:\n",
    "        Pmor[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i)\n",
    "        Pber[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "        Pbin[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "\n",
    "        Pmor[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pber[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pbin[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        \n",
    "        Pmor[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pmor.row(istates[(0,i)]))\n",
    "        Pber[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pber.row(istates[(0,i)]))\n",
    "        Pbin[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pbin.row(istates[(0,i)]))\n",
    "        \n",
    "    \n",
    "    if i != N-1:\n",
    "        Pmor[istates[(1,i)],istates[(1,i+1)]] = r / (r*(i+1) + N-i-1) * (N-1-i) / (N-1)\n",
    "        Pber[istates[(1,i)],istates[(1,N-1)]] = r / (r*(i+1) + N-i-1) * p\n",
    "        for k in range(1,N-i):\n",
    "            Pbin[istates[(1,i)],istates[(1,i+k)]] = r / (r*(i+1) + N-i-1) * binomial(N-i, k) * p**k * (1-p)**(N-i - k)\n",
    "\n",
    "        Pmor[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*(i+1) + N-i-1)\n",
    "        Pber[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*(i+1) + N-i-1)\n",
    "        Pbin[istates[(1,i)],istates[(0,i)]] = (N-i) / (r*(i+1) + N-i-1)\n",
    "        \n",
    "        Pmor[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pmor.row(istates[(1,i)]))\n",
    "        Pber[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pber.row(istates[(1,i)]))\n",
    "        Pbin[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pbin.row(istates[(1,i)]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way.. \n",
    "Pmor = Pmor.change_ring(SR).change_ring(F)\n",
    "Pber = Pber.change_ring(SR).change_ring(F)\n",
    "Pbin = Pbin.change_ring(SR).change_ring(F)\n",
    "\n",
    "Qmor = identity_matrix(len(states)-2) - Pmor[1:-1,1:-1]\n",
    "Qbin = identity_matrix(len(states)-2) - Pbin[1:-1,1:-1]\n",
    "Qber = identity_matrix(len(states)-2) - Pber[1:-1,1:-1]\n",
    "\n",
    "Phimor = Qmor.solve_right(vector(Pmor[1:-1,-1]))\n",
    "Phibin = Qbin.solve_right(vector(Pbin[1:-1,-1]))\n",
    "Phiber = Qber.solve_right(vector(Pber[1:-1,-1]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way\n",
    "Phimor = Phimor.change_ring(SR).change_ring(F)\n",
    "Phibin = Phibin.change_ring(SR).change_ring(F)\n",
    "Phiber = Phiber.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBin = Qbin.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBin = TimeBin.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBer = Qber.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBer = TimeBer.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMor = Qmor.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMor = TimeMor.change_ring(SR).change_ring(F)\n",
    "\n",
    "# Conditionated times\n",
    "PmorF = copy(Pmor)\n",
    "PberF = copy(Pber)\n",
    "PbinF = copy(Pbin)\n",
    "\n",
    "for i in range(1,len(states)-1):\n",
    "    PmorF.rescale_col(i, Phimor[i-1])\n",
    "    PmorF.rescale_row(i, 1/Phimor[i-1])\n",
    "    \n",
    "    PberF.rescale_col(i, Phiber[i-1])\n",
    "    PberF.rescale_row(i, 1/Phiber[i-1])\n",
    "    \n",
    "    PbinF.rescale_col(i, Phibin[i-1])\n",
    "    PbinF.rescale_row(i, 1/Phibin[i-1])\n",
    "\n",
    "QmorF = identity_matrix(len(states)-2) - PmorF[1:-1,1:-1]\n",
    "QbinF = identity_matrix(len(states)-2) - PbinF[1:-1,1:-1]\n",
    "QberF = identity_matrix(len(states)-2) - PberF[1:-1,1:-1]\n",
    "    \n",
    "TimeBinF = QbinF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBinF = TimeBinF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBerF = QberF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBerF = TimeBerF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMorF = QmorF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMorF = TimeMorF.change_ring(SR).change_ring(F)\n",
    "\n",
    "#TimeMorNF = ((TimeMor - Phimor[0] * TimeMorF) / (1 - Phimor[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 70,
   "id": "c2bc8ba0",
   "metadata": {},
   "outputs": [],
   "source": [
    "show(Pbin)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 71,
   "id": "4f0016ce",
   "metadata": {},
   "outputs": [],
   "source": [
    "show(Pber)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 72,
   "id": "a40df0a7",
   "metadata": {},
   "outputs": [],
   "source": [
    "%%time\n",
    "N = 4\n",
    "\n",
    "states = list(it.product((0,1), range(N)))\n",
    "istates = { s:i for i,s in enumerate(states) }\n",
    "\n",
    "Pmor = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pbin = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pber = matrix(F, [[0]* len(states)] * len(states))\n",
    "\n",
    "Pmor[0,0] = Pbin[0,0] = Pber[0,0] = 1\n",
    "Pmor[len(states)-1, len(states)-1] = Pbin[len(states)-1, len(states)-1] = Pber[len(states)-1, len(states)-1] = 1\n",
    "\n",
    "for i in range(N):\n",
    "    # null center\n",
    "    if i != 0:\n",
    "        Pmor[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i)\n",
    "        Pber[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "        Pbin[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "\n",
    "        Pmor[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pber[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pbin[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        \n",
    "        Pmor[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pmor.row(istates[(0,i)]))\n",
    "        Pber[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pber.row(istates[(0,i)]))\n",
    "        Pbin[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pbin.row(istates[(0,i)]))\n",
    "        \n",
    "    \n",
    "    if i != N-1:\n",
    "        Pmor[istates[(1,i)],istates[(1,i+1)]] = r / (r*(i+1) + N-i-1) * (N-1-i) / (N-1)\n",
    "        Pber[istates[(1,i)],istates[(1,N-1)]] = r / (r*(i+1) + N-i-1) * p\n",
    "        for k in range(1,N-i):\n",
    "            Pbin[istates[(1,i)],istates[(1,i+k)]] = r / (r*(i+1) + N-i-1) * binomial(N-i, k) * p**k * (1-p)**(N-i - k)\n",
    "\n",
    "        Pmor[istates[(1,i)],istates[(0,i)]] = (N-i-1) / (r*(i+1) + N-i-1)\n",
    "        Pber[istates[(1,i)],istates[(0,i)]] = (N-i-1) / (r*(i+1) + N-i-1)\n",
    "        Pbin[istates[(1,i)],istates[(0,i)]] = (N-i-1) / (r*(i+1) + N-i-1)\n",
    "        \n",
    "        Pmor[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pmor.row(istates[(1,i)]))\n",
    "        Pber[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pber.row(istates[(1,i)]))\n",
    "        Pbin[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pbin.row(istates[(1,i)]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way.. \n",
    "Pmor = Pmor.change_ring(SR).change_ring(F)\n",
    "Pber = Pber.change_ring(SR).change_ring(F)\n",
    "Pbin = Pbin.change_ring(SR).change_ring(F)\n",
    "\n",
    "Qmor = identity_matrix(len(states)-2) - Pmor[1:-1,1:-1]\n",
    "Qbin = identity_matrix(len(states)-2) - Pbin[1:-1,1:-1]\n",
    "Qber = identity_matrix(len(states)-2) - Pber[1:-1,1:-1]\n",
    "\n",
    "Phimor = Qmor.solve_right(vector(Pmor[1:-1,-1]))\n",
    "Phibin = Qbin.solve_right(vector(Pbin[1:-1,-1]))\n",
    "Phiber = Qber.solve_right(vector(Pber[1:-1,-1]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way\n",
    "Phimor = Phimor.change_ring(SR).change_ring(F)\n",
    "Phibin = Phibin.change_ring(SR).change_ring(F)\n",
    "Phiber = Phiber.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBin = Qbin.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBin = TimeBin.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBer = Qber.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBer = TimeBer.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMor = Qmor.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMor = TimeMor.change_ring(SR).change_ring(F)\n",
    "\n",
    "# Conditionated times\n",
    "PmorF = copy(Pmor)\n",
    "PberF = copy(Pber)\n",
    "PbinF = copy(Pbin)\n",
    "\n",
    "for i in range(1,len(states)-1):\n",
    "    PmorF.rescale_col(i, Phimor[i-1])\n",
    "    PmorF.rescale_row(i, 1/Phimor[i-1])\n",
    "    \n",
    "    PberF.rescale_col(i, Phiber[i-1])\n",
    "    PberF.rescale_row(i, 1/Phiber[i-1])\n",
    "    \n",
    "    PbinF.rescale_col(i, Phibin[i-1])\n",
    "    PbinF.rescale_row(i, 1/Phibin[i-1])\n",
    "\n",
    "QmorF = identity_matrix(len(states)-2) - PmorF[1:-1,1:-1]\n",
    "QbinF = identity_matrix(len(states)-2) - PbinF[1:-1,1:-1]\n",
    "QberF = identity_matrix(len(states)-2) - PberF[1:-1,1:-1]\n",
    "    \n",
    "TimeBinF = QbinF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBinF = TimeBinF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBerF = QberF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBerF = TimeBerF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMorF = QmorF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMorF = TimeMorF.change_ring(SR).change_ring(F)\n",
    "\n",
    "#TimeMorNF = ((TimeMor - Phimor[0] * TimeMorF) / (1 - Phimor[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 73,
   "id": "c72e51e3",
   "metadata": {},
   "outputs": [],
   "source": [
    "show(Pmor)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 74,
   "id": "32103575",
   "metadata": {},
   "outputs": [],
   "source": [
    "show(Pber)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 75,
   "id": "8423d4bf",
   "metadata": {},
   "outputs": [],
   "source": [
    "MeanTimeBin = 1/N * TimeBin[istates[(1,0)]] + (N-1)/N * TimeBin[istates[(0,1)]]\n",
    "MeanTimeBer = 1/N * TimeBer[istates[(1,0)]] + (N-1)/N * TimeBer[istates[(0,1)]]\n",
    "MeanTimeMor = 1/N * TimeMor[istates[(1,0)]] + (N-1)/N * TimeMor[istates[(0,1)]]\n",
    "\n",
    "MeanTimeBinF = 1/N * TimeBinF[istates[(1,0)]] + (N-1)/N * TimeBinF[istates[(0,1)]]\n",
    "MeanTimeBerF = 1/N * TimeBerF[istates[(1,0)]] + (N-1)/N * TimeBerF[istates[(0,1)]]\n",
    "MeanTimeMorF = 1/N * TimeMorF[istates[(1,0)]] + (N-1)/N * TimeMorF[istates[(0,1)]]\n",
    "\n",
    "meanPhimor = 1/N * Phimor[istates[(1,0)]] + (N-1)/N * Phimor[istates[(0,1)]]\n",
    "MeanTimeMorNF = ((MeanTimeMor - meanPhimor * MeanTimeMorF) / (1 - meanPhimor))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "meanPhibin = 1/N * Phibin[istates[(1,0)]] + (N-1)/N * Phibin[istates[(0,1)]]\n",
    "MeanTimeBinNF = ((MeanTimeBin - meanPhibin * MeanTimeBinF) / (1 - meanPhibin))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "meanPhiber = 1/N * Phiber[istates[(1,0)]] + (N-1)/N * Phiber[istates[(0,1)]]\n",
    "MeanTimeBerNF = ((MeanTimeBer - meanPhiber * MeanTimeBerF) / (1 - meanPhiber))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "                 #TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 76,
   "id": "f2989a3f",
   "metadata": {},
   "outputs": [],
   "source": [
    "maxr = 4\n",
    "plot3d(log(MeanTimeBinF), (r,1,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMorF), (r,1,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBerF), (r,1,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 77,
   "id": "93844b7a",
   "metadata": {},
   "outputs": [],
   "source": [
    "plot3d(log(MeanTimeBinNF), (r,0,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMorNF), (r,0,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBerNF), (r,0,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 78,
   "id": "ed4d6cb8",
   "metadata": {},
   "outputs": [],
   "source": [
    "plot3d(log(MeanTimeBin), (r,0,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMor), (r,0,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBer), (r,0,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 79,
   "id": "5c5c391d",
   "metadata": {},
   "outputs": [],
   "source": [
    "def pc(f):\n",
    "    a = 0\n",
    "    sa = (f(p=a) > 0)\n",
    "    b = 1\n",
    "    while b-a > 1e-18:\n",
    "        c = (a+b)/2\n",
    "        sc = (f(p=c) > 0)\n",
    "        if sc ^ sa:\n",
    "            a = c\n",
    "        else:\n",
    "            b = c\n",
    "    \n",
    "    return n((b+a) / 2)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 80,
   "id": "f9317c7f",
   "metadata": {},
   "outputs": [],
   "source": [
    "rs = [0,1/80..2/10]\n",
    "rs.extend([2/10,2/10+1/40..1][1:-1])\n",
    "rs.extend([1,1+1/10..10])\n",
    "pcsbin = []\n",
    "pcsber = []\n",
    "tmpbin = (meanPhibin - meanPhimor)\n",
    "tmpber = (meanPhiber - meanPhimor)\n",
    "for valr in rs:\n",
    "    if valr == 0:\n",
    "        pcsbin.append(0)\n",
    "        pcsber.append(0)\n",
    "    else:\n",
    "        pcsbin.append(pc(tmpbin.numerator().subs(r=valr)))\n",
    "        pcsber.append(pc(tmpber.numerator().subs(r=valr)))\n",
    "    "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 81,
   "id": "2d79b955",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=1) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 82,
   "id": "82afaf4f",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=1) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 83,
   "id": "a5c6b083",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=.9) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 84,
   "id": "2bbfc79c",
   "metadata": {},
   "outputs": [],
   "source": [
    "show(Pbin)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 85,
   "id": "e0aa446a",
   "metadata": {},
   "outputs": [],
   "source": [
    "states"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 86,
   "id": "6d96b528",
   "metadata": {},
   "outputs": [],
   "source": [
    "sum(Pbin.row(1))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 87,
   "id": "a41552b7",
   "metadata": {},
   "outputs": [],
   "source": [
    "sum(Pbin.row(2))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 88,
   "id": "0732fbeb",
   "metadata": {},
   "outputs": [],
   "source": [
    "sum(Pbin.row(3))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 89,
   "id": "bd3dd63e",
   "metadata": {},
   "outputs": [],
   "source": [
    "%%time\n",
    "N = 4\n",
    "\n",
    "states = list(it.product((0,1), range(N)))\n",
    "istates = { s:i for i,s in enumerate(states) }\n",
    "\n",
    "Pmor = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pbin = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pber = matrix(F, [[0]* len(states)] * len(states))\n",
    "\n",
    "Pmor[0,0] = Pbin[0,0] = Pber[0,0] = 1\n",
    "Pmor[len(states)-1, len(states)-1] = Pbin[len(states)-1, len(states)-1] = Pber[len(states)-1, len(states)-1] = 1\n",
    "\n",
    "for i in range(N):\n",
    "    # null center\n",
    "    if i != 0:\n",
    "        Pmor[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i)\n",
    "        Pber[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "        Pbin[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "\n",
    "        Pmor[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pber[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pbin[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        \n",
    "        Pmor[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pmor.row(istates[(0,i)]))\n",
    "        Pber[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pber.row(istates[(0,i)]))\n",
    "        Pbin[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pbin.row(istates[(0,i)]))\n",
    "        \n",
    "    \n",
    "    if i != N-1:\n",
    "        Pmor[istates[(1,i)],istates[(1,i+1)]] = r / (r*(i+1) + N-i-1) * (N-1-i) / (N-1)\n",
    "        Pber[istates[(1,i)],istates[(1,N-1)]] = r / (r*(i+1) + N-i-1) * p\n",
    "        for k in [1..N-i-1]:\n",
    "            Pbin[istates[(1,i)],istates[(1,i+k)]] = r / (r*(i+1) + N-i-1) * binomial(N-i, k) * p**k * (1-p)**(N-i - k)\n",
    "\n",
    "        Pmor[istates[(1,i)],istates[(0,i)]] = (N-i-1) / (r*(i+1) + N-i-1)\n",
    "        Pber[istates[(1,i)],istates[(0,i)]] = (N-i-1) / (r*(i+1) + N-i-1)\n",
    "        Pbin[istates[(1,i)],istates[(0,i)]] = (N-i-1) / (r*(i+1) + N-i-1)\n",
    "        \n",
    "        Pmor[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pmor.row(istates[(1,i)]))\n",
    "        Pber[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pber.row(istates[(1,i)]))\n",
    "        Pbin[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pbin.row(istates[(1,i)]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way.. \n",
    "Pmor = Pmor.change_ring(SR).change_ring(F)\n",
    "Pber = Pber.change_ring(SR).change_ring(F)\n",
    "Pbin = Pbin.change_ring(SR).change_ring(F)\n",
    "\n",
    "Qmor = identity_matrix(len(states)-2) - Pmor[1:-1,1:-1]\n",
    "Qbin = identity_matrix(len(states)-2) - Pbin[1:-1,1:-1]\n",
    "Qber = identity_matrix(len(states)-2) - Pber[1:-1,1:-1]\n",
    "\n",
    "Phimor = Qmor.solve_right(vector(Pmor[1:-1,-1]))\n",
    "Phibin = Qbin.solve_right(vector(Pbin[1:-1,-1]))\n",
    "Phiber = Qber.solve_right(vector(Pber[1:-1,-1]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way\n",
    "Phimor = Phimor.change_ring(SR).change_ring(F)\n",
    "Phibin = Phibin.change_ring(SR).change_ring(F)\n",
    "Phiber = Phiber.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBin = Qbin.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBin = TimeBin.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBer = Qber.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBer = TimeBer.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMor = Qmor.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMor = TimeMor.change_ring(SR).change_ring(F)\n",
    "\n",
    "# Conditionated times\n",
    "PmorF = copy(Pmor)\n",
    "PberF = copy(Pber)\n",
    "PbinF = copy(Pbin)\n",
    "\n",
    "for i in range(1,len(states)-1):\n",
    "    PmorF.rescale_col(i, Phimor[i-1])\n",
    "    PmorF.rescale_row(i, 1/Phimor[i-1])\n",
    "    \n",
    "    PberF.rescale_col(i, Phiber[i-1])\n",
    "    PberF.rescale_row(i, 1/Phiber[i-1])\n",
    "    \n",
    "    PbinF.rescale_col(i, Phibin[i-1])\n",
    "    PbinF.rescale_row(i, 1/Phibin[i-1])\n",
    "\n",
    "QmorF = identity_matrix(len(states)-2) - PmorF[1:-1,1:-1]\n",
    "QbinF = identity_matrix(len(states)-2) - PbinF[1:-1,1:-1]\n",
    "QberF = identity_matrix(len(states)-2) - PberF[1:-1,1:-1]\n",
    "    \n",
    "TimeBinF = QbinF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBinF = TimeBinF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBerF = QberF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBerF = TimeBerF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMorF = QmorF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMorF = TimeMorF.change_ring(SR).change_ring(F)\n",
    "\n",
    "#TimeMorNF = ((TimeMor - Phimor[0] * TimeMorF) / (1 - Phimor[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 90,
   "id": "3a5e40cf",
   "metadata": {},
   "outputs": [],
   "source": [
    "sum(Pbin.row(3))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 91,
   "id": "a0c6b5f7",
   "metadata": {},
   "outputs": [],
   "source": [
    "states"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 92,
   "id": "bbebe3a4",
   "metadata": {},
   "outputs": [],
   "source": [
    "show(Pbin)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 93,
   "id": "860dd47b",
   "metadata": {},
   "outputs": [],
   "source": [
    "%%time\n",
    "N = 4\n",
    "\n",
    "states = list(it.product((0,1), range(N)))\n",
    "istates = { s:i for i,s in enumerate(states) }\n",
    "\n",
    "Pmor = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pbin = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pber = matrix(F, [[0]* len(states)] * len(states))\n",
    "\n",
    "Pmor[0,0] = Pbin[0,0] = Pber[0,0] = 1\n",
    "Pmor[len(states)-1, len(states)-1] = Pbin[len(states)-1, len(states)-1] = Pber[len(states)-1, len(states)-1] = 1\n",
    "\n",
    "for i in range(N):\n",
    "    # null center\n",
    "    if i != 0:\n",
    "        Pmor[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i)\n",
    "        Pber[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "        Pbin[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "\n",
    "        Pmor[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pber[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pbin[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        \n",
    "        Pmor[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pmor.row(istates[(0,i)]))\n",
    "        Pber[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pber.row(istates[(0,i)]))\n",
    "        Pbin[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pbin.row(istates[(0,i)]))\n",
    "        \n",
    "    \n",
    "    if i != N-1:\n",
    "        Pmor[istates[(1,i)],istates[(1,i+1)]] = r / (r*(i+1) + N-i-1) * (N-1-i) / (N-1)\n",
    "        Pber[istates[(1,i)],istates[(1,N-1)]] = r / (r*(i+1) + N-i-1) * p\n",
    "        for k in [1..N-i-1]:\n",
    "            Pbin[istates[(1,i)],istates[(1,i+k)]] = r / (r*(i+1) + N-i-1) * binomial(N-i-1, k) * p**k * (1-p)**(N-i-1 - k)\n",
    "\n",
    "        Pmor[istates[(1,i)],istates[(0,i)]] = (N-i-1) / (r*(i+1) + N-i-1)\n",
    "        Pber[istates[(1,i)],istates[(0,i)]] = (N-i-1) / (r*(i+1) + N-i-1)\n",
    "        Pbin[istates[(1,i)],istates[(0,i)]] = (N-i-1) / (r*(i+1) + N-i-1)\n",
    "        \n",
    "        Pmor[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pmor.row(istates[(1,i)]))\n",
    "        Pber[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pber.row(istates[(1,i)]))\n",
    "        Pbin[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pbin.row(istates[(1,i)]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way.. \n",
    "Pmor = Pmor.change_ring(SR).change_ring(F)\n",
    "Pber = Pber.change_ring(SR).change_ring(F)\n",
    "Pbin = Pbin.change_ring(SR).change_ring(F)\n",
    "\n",
    "Qmor = identity_matrix(len(states)-2) - Pmor[1:-1,1:-1]\n",
    "Qbin = identity_matrix(len(states)-2) - Pbin[1:-1,1:-1]\n",
    "Qber = identity_matrix(len(states)-2) - Pber[1:-1,1:-1]\n",
    "\n",
    "Phimor = Qmor.solve_right(vector(Pmor[1:-1,-1]))\n",
    "Phibin = Qbin.solve_right(vector(Pbin[1:-1,-1]))\n",
    "Phiber = Qber.solve_right(vector(Pber[1:-1,-1]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way\n",
    "Phimor = Phimor.change_ring(SR).change_ring(F)\n",
    "Phibin = Phibin.change_ring(SR).change_ring(F)\n",
    "Phiber = Phiber.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBin = Qbin.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBin = TimeBin.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBer = Qber.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBer = TimeBer.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMor = Qmor.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMor = TimeMor.change_ring(SR).change_ring(F)\n",
    "\n",
    "# Conditionated times\n",
    "PmorF = copy(Pmor)\n",
    "PberF = copy(Pber)\n",
    "PbinF = copy(Pbin)\n",
    "\n",
    "for i in range(1,len(states)-1):\n",
    "    PmorF.rescale_col(i, Phimor[i-1])\n",
    "    PmorF.rescale_row(i, 1/Phimor[i-1])\n",
    "    \n",
    "    PberF.rescale_col(i, Phiber[i-1])\n",
    "    PberF.rescale_row(i, 1/Phiber[i-1])\n",
    "    \n",
    "    PbinF.rescale_col(i, Phibin[i-1])\n",
    "    PbinF.rescale_row(i, 1/Phibin[i-1])\n",
    "\n",
    "QmorF = identity_matrix(len(states)-2) - PmorF[1:-1,1:-1]\n",
    "QbinF = identity_matrix(len(states)-2) - PbinF[1:-1,1:-1]\n",
    "QberF = identity_matrix(len(states)-2) - PberF[1:-1,1:-1]\n",
    "    \n",
    "TimeBinF = QbinF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBinF = TimeBinF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBerF = QberF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBerF = TimeBerF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMorF = QmorF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMorF = TimeMorF.change_ring(SR).change_ring(F)\n",
    "\n",
    "#TimeMorNF = ((TimeMor - Phimor[0] * TimeMorF) / (1 - Phimor[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 94,
   "id": "c041432e",
   "metadata": {},
   "outputs": [],
   "source": [
    "sum(Pbin.row(3))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 95,
   "id": "043f7d53",
   "metadata": {},
   "outputs": [],
   "source": [
    "states"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 96,
   "id": "f8da74da",
   "metadata": {},
   "outputs": [],
   "source": [
    "show(Pbin)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 97,
   "id": "6c7ec219",
   "metadata": {},
   "outputs": [],
   "source": [
    "show(Pbin)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 98,
   "id": "41e66b96",
   "metadata": {},
   "outputs": [],
   "source": [
    "show(Pber)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 99,
   "id": "6485e895",
   "metadata": {},
   "outputs": [],
   "source": [
    "MeanTimeBin = 1/N * TimeBin[istates[(1,0)]] + (N-1)/N * TimeBin[istates[(0,1)]]\n",
    "MeanTimeBer = 1/N * TimeBer[istates[(1,0)]] + (N-1)/N * TimeBer[istates[(0,1)]]\n",
    "MeanTimeMor = 1/N * TimeMor[istates[(1,0)]] + (N-1)/N * TimeMor[istates[(0,1)]]\n",
    "\n",
    "MeanTimeBinF = 1/N * TimeBinF[istates[(1,0)]] + (N-1)/N * TimeBinF[istates[(0,1)]]\n",
    "MeanTimeBerF = 1/N * TimeBerF[istates[(1,0)]] + (N-1)/N * TimeBerF[istates[(0,1)]]\n",
    "MeanTimeMorF = 1/N * TimeMorF[istates[(1,0)]] + (N-1)/N * TimeMorF[istates[(0,1)]]\n",
    "\n",
    "meanPhimor = 1/N * Phimor[istates[(1,0)]] + (N-1)/N * Phimor[istates[(0,1)]]\n",
    "MeanTimeMorNF = ((MeanTimeMor - meanPhimor * MeanTimeMorF) / (1 - meanPhimor))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "meanPhibin = 1/N * Phibin[istates[(1,0)]] + (N-1)/N * Phibin[istates[(0,1)]]\n",
    "MeanTimeBinNF = ((MeanTimeBin - meanPhibin * MeanTimeBinF) / (1 - meanPhibin))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "meanPhiber = 1/N * Phiber[istates[(1,0)]] + (N-1)/N * Phiber[istates[(0,1)]]\n",
    "MeanTimeBerNF = ((MeanTimeBer - meanPhiber * MeanTimeBerF) / (1 - meanPhiber))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "                 #TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 100,
   "id": "9e824c30",
   "metadata": {},
   "outputs": [],
   "source": [
    "maxr = 4\n",
    "plot3d(log(MeanTimeBinF), (r,1,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMorF), (r,1,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBerF), (r,1,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 101,
   "id": "deba91bf",
   "metadata": {},
   "outputs": [],
   "source": [
    "plot3d(log(MeanTimeBinNF), (r,0,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMorNF), (r,0,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBerNF), (r,0,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 102,
   "id": "f5a0bbe5",
   "metadata": {},
   "outputs": [],
   "source": [
    "plot3d(log(MeanTimeBin), (r,0,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMor), (r,0,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBer), (r,0,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 103,
   "id": "a9ecf28e",
   "metadata": {},
   "outputs": [],
   "source": [
    "maxr = 4\n",
    "plot3d(log(MeanTimeBinF), (r,0,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMorF), (r,0,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBerF), (r,0,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 104,
   "id": "91185b89",
   "metadata": {},
   "outputs": [],
   "source": [
    "plot3d(log(MeanTimeBinNF), (r,0,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMorNF), (r,0,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBerNF), (r,0,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 105,
   "id": "fa555e02",
   "metadata": {},
   "outputs": [],
   "source": [
    "plot3d(log(MeanTimeBin), (r,0,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMor), (r,0,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBer), (r,0,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 106,
   "id": "f391f39b",
   "metadata": {},
   "outputs": [],
   "source": [
    "def pc(f):\n",
    "    a = 0\n",
    "    sa = (f(p=a) > 0)\n",
    "    b = 1\n",
    "    while b-a > 1e-18:\n",
    "        c = (a+b)/2\n",
    "        sc = (f(p=c) > 0)\n",
    "        if sc ^ sa:\n",
    "            a = c\n",
    "        else:\n",
    "            b = c\n",
    "    \n",
    "    return n((b+a) / 2)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 107,
   "id": "4ef632e0",
   "metadata": {},
   "outputs": [],
   "source": [
    "rs = [0,1/80..2/10]\n",
    "rs.extend([2/10,2/10+1/40..1][1:-1])\n",
    "rs.extend([1,1+1/10..10])\n",
    "pcsbin = []\n",
    "pcsber = []\n",
    "tmpbin = (meanPhibin - meanPhimor)\n",
    "tmpber = (meanPhiber - meanPhimor)\n",
    "for valr in rs:\n",
    "    if valr == 0:\n",
    "        pcsbin.append(0)\n",
    "        pcsber.append(0)\n",
    "    else:\n",
    "        pcsbin.append(pc(tmpbin.numerator().subs(r=valr)))\n",
    "        pcsber.append(pc(tmpber.numerator().subs(r=valr)))\n",
    "    "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 108,
   "id": "012d78e2",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=.9) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 109,
   "id": "af77511b",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, pcsbin)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 110,
   "id": "ec0cdaeb",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.loglog(rs, pcsbin)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 111,
   "id": "e13f88d6",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=1) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 112,
   "id": "11b3d57a",
   "metadata": {},
   "outputs": [],
   "source": [
    "%%time\n",
    "N = 8\n",
    "\n",
    "states = list(it.product((0,1), range(N)))\n",
    "istates = { s:i for i,s in enumerate(states) }\n",
    "\n",
    "Pmor = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pbin = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pber = matrix(F, [[0]* len(states)] * len(states))\n",
    "\n",
    "Pmor[0,0] = Pbin[0,0] = Pber[0,0] = 1\n",
    "Pmor[len(states)-1, len(states)-1] = Pbin[len(states)-1, len(states)-1] = Pber[len(states)-1, len(states)-1] = 1\n",
    "\n",
    "for i in range(N):\n",
    "    # null center\n",
    "    if i != 0:\n",
    "        Pmor[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i)\n",
    "        Pber[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "        Pbin[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "\n",
    "        Pmor[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pber[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pbin[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        \n",
    "        Pmor[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pmor.row(istates[(0,i)]))\n",
    "        Pber[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pber.row(istates[(0,i)]))\n",
    "        Pbin[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pbin.row(istates[(0,i)]))\n",
    "        \n",
    "    \n",
    "    if i != N-1:\n",
    "        Pmor[istates[(1,i)],istates[(1,i+1)]] = r / (r*(i+1) + N-i-1) * (N-1-i) / (N-1)\n",
    "        Pber[istates[(1,i)],istates[(1,N-1)]] = r / (r*(i+1) + N-i-1) * p\n",
    "        for k in [1..N-i-1]:\n",
    "            Pbin[istates[(1,i)],istates[(1,i+k)]] = r / (r*(i+1) + N-i-1) * binomial(N-i-1, k) * p**k * (1-p)**(N-i-1 - k)\n",
    "\n",
    "        Pmor[istates[(1,i)],istates[(0,i)]] = (N-i-1) / (r*(i+1) + N-i-1)\n",
    "        Pber[istates[(1,i)],istates[(0,i)]] = (N-i-1) / (r*(i+1) + N-i-1)\n",
    "        Pbin[istates[(1,i)],istates[(0,i)]] = (N-i-1) / (r*(i+1) + N-i-1)\n",
    "        \n",
    "        Pmor[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pmor.row(istates[(1,i)]))\n",
    "        Pber[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pber.row(istates[(1,i)]))\n",
    "        Pbin[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pbin.row(istates[(1,i)]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way.. \n",
    "Pmor = Pmor.change_ring(SR).change_ring(F)\n",
    "Pber = Pber.change_ring(SR).change_ring(F)\n",
    "Pbin = Pbin.change_ring(SR).change_ring(F)\n",
    "\n",
    "Qmor = identity_matrix(len(states)-2) - Pmor[1:-1,1:-1]\n",
    "Qbin = identity_matrix(len(states)-2) - Pbin[1:-1,1:-1]\n",
    "Qber = identity_matrix(len(states)-2) - Pber[1:-1,1:-1]\n",
    "\n",
    "Phimor = Qmor.solve_right(vector(Pmor[1:-1,-1]))\n",
    "Phibin = Qbin.solve_right(vector(Pbin[1:-1,-1]))\n",
    "Phiber = Qber.solve_right(vector(Pber[1:-1,-1]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way\n",
    "Phimor = Phimor.change_ring(SR).change_ring(F)\n",
    "Phibin = Phibin.change_ring(SR).change_ring(F)\n",
    "Phiber = Phiber.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBin = Qbin.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBin = TimeBin.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBer = Qber.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBer = TimeBer.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMor = Qmor.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMor = TimeMor.change_ring(SR).change_ring(F)\n",
    "\n",
    "# Conditionated times\n",
    "PmorF = copy(Pmor)\n",
    "PberF = copy(Pber)\n",
    "PbinF = copy(Pbin)\n",
    "\n",
    "for i in range(1,len(states)-1):\n",
    "    PmorF.rescale_col(i, Phimor[i-1])\n",
    "    PmorF.rescale_row(i, 1/Phimor[i-1])\n",
    "    \n",
    "    PberF.rescale_col(i, Phiber[i-1])\n",
    "    PberF.rescale_row(i, 1/Phiber[i-1])\n",
    "    \n",
    "    PbinF.rescale_col(i, Phibin[i-1])\n",
    "    PbinF.rescale_row(i, 1/Phibin[i-1])\n",
    "\n",
    "QmorF = identity_matrix(len(states)-2) - PmorF[1:-1,1:-1]\n",
    "QbinF = identity_matrix(len(states)-2) - PbinF[1:-1,1:-1]\n",
    "QberF = identity_matrix(len(states)-2) - PberF[1:-1,1:-1]\n",
    "    \n",
    "TimeBinF = QbinF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBinF = TimeBinF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBerF = QberF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBerF = TimeBerF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMorF = QmorF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMorF = TimeMorF.change_ring(SR).change_ring(F)\n",
    "\n",
    "#TimeMorNF = ((TimeMor - Phimor[0] * TimeMorF) / (1 - Phimor[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 113,
   "id": "0c142593",
   "metadata": {},
   "outputs": [],
   "source": [
    "MeanTimeBin = 1/N * TimeBin[istates[(1,0)]] + (N-1)/N * TimeBin[istates[(0,1)]]\n",
    "MeanTimeBer = 1/N * TimeBer[istates[(1,0)]] + (N-1)/N * TimeBer[istates[(0,1)]]\n",
    "MeanTimeMor = 1/N * TimeMor[istates[(1,0)]] + (N-1)/N * TimeMor[istates[(0,1)]]\n",
    "\n",
    "MeanTimeBinF = 1/N * TimeBinF[istates[(1,0)]] + (N-1)/N * TimeBinF[istates[(0,1)]]\n",
    "MeanTimeBerF = 1/N * TimeBerF[istates[(1,0)]] + (N-1)/N * TimeBerF[istates[(0,1)]]\n",
    "MeanTimeMorF = 1/N * TimeMorF[istates[(1,0)]] + (N-1)/N * TimeMorF[istates[(0,1)]]\n",
    "\n",
    "meanPhimor = 1/N * Phimor[istates[(1,0)]] + (N-1)/N * Phimor[istates[(0,1)]]\n",
    "MeanTimeMorNF = ((MeanTimeMor - meanPhimor * MeanTimeMorF) / (1 - meanPhimor))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "meanPhibin = 1/N * Phibin[istates[(1,0)]] + (N-1)/N * Phibin[istates[(0,1)]]\n",
    "MeanTimeBinNF = ((MeanTimeBin - meanPhibin * MeanTimeBinF) / (1 - meanPhibin))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "meanPhiber = 1/N * Phiber[istates[(1,0)]] + (N-1)/N * Phiber[istates[(0,1)]]\n",
    "MeanTimeBerNF = ((MeanTimeBer - meanPhiber * MeanTimeBerF) / (1 - meanPhiber))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "                 #TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 114,
   "id": "4802745c",
   "metadata": {},
   "outputs": [],
   "source": [
    "rs = [0.1,0.1+1/80..2/10]\n",
    "rs.extend([2/10,2/10+1/40..1][1:-1])\n",
    "rs.extend([1,1+1/10..10])\n",
    "pcsbin = []\n",
    "pcsber = []\n",
    "tmpbin = (meanPhibin - meanPhimor)\n",
    "tmpber = (meanPhiber - meanPhimor)\n",
    "for valr in rs:\n",
    "    if valr == 0:\n",
    "        pcsbin.append(0)\n",
    "        pcsber.append(0)\n",
    "    else:\n",
    "        pcsbin.append(pc(tmpbin.numerator().subs(r=valr)))\n",
    "        pcsber.append(pc(tmpber.numerator().subs(r=valr)))\n",
    "    "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 115,
   "id": "ffa5e258",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=1) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 116,
   "id": "9da4f48c",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.loglog(rs, pcsbin)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 117,
   "id": "2e9f9663",
   "metadata": {},
   "outputs": [],
   "source": [
    "%%time\n",
    "N = 8\n",
    "\n",
    "states = list(it.product((0,1), range(N)))\n",
    "istates = { s:i for i,s in enumerate(states) }\n",
    "\n",
    "Pmor = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pbin = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pber = matrix(F, [[0]* len(states)] * len(states))\n",
    "\n",
    "Pmor[0,0] = Pbin[0,0] = Pber[0,0] = 1\n",
    "Pmor[len(states)-1, len(states)-1] = Pbin[len(states)-1, len(states)-1] = Pber[len(states)-1, len(states)-1] = 1\n",
    "\n",
    "for i in range(N):\n",
    "    # null center\n",
    "    if i != 0:\n",
    "        Pmor[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i)\n",
    "        Pber[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "        Pbin[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "\n",
    "        Pmor[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pber[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pbin[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        \n",
    "        Pmor[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pmor.row(istates[(0,i)]))\n",
    "        Pber[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pber.row(istates[(0,i)]))\n",
    "        Pbin[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pbin.row(istates[(0,i)]))\n",
    "        \n",
    "    \n",
    "    if i != N-1:\n",
    "        Pmor[istates[(1,i)],istates[(1,i+1)]] = r / (r*(i+1) + N-i-1) * (N-1-i) / (N-1)\n",
    "        Pber[istates[(1,i)],istates[(1,N-1)]] = r / (r*(i+1) + N-i-1) * p\n",
    "        for k in [1..N-i-1]:\n",
    "            Pbin[istates[(1,i)],istates[(1,i+k)]] = r / (r*(i+1) + N-i-1) * binomial(N-i-1, k) * p**k * (1-p)**(N-i-1 - k)\n",
    "\n",
    "        Pmor[istates[(1,i)],istates[(0,i)]] = (N-i-1) / (r*(i+1) + N-i-1)\n",
    "        Pber[istates[(1,i)],istates[(0,i)]] = (N-i-1) / (r*(i+1) + N-i-1)\n",
    "        Pbin[istates[(1,i)],istates[(0,i)]] = (N-i-1) / (r*(i+1) + N-i-1)\n",
    "        \n",
    "        Pmor[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pmor.row(istates[(1,i)]))\n",
    "        Pber[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pber.row(istates[(1,i)]))\n",
    "        Pbin[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pbin.row(istates[(1,i)]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way.. \n",
    "Pmor = Pmor.change_ring(SR).change_ring(F)\n",
    "Pber = Pber.change_ring(SR).change_ring(F)\n",
    "Pbin = Pbin.change_ring(SR).change_ring(F)\n",
    "\n",
    "Qmor = identity_matrix(len(states)-2) - Pmor[1:-1,1:-1]\n",
    "Qbin = identity_matrix(len(states)-2) - Pbin[1:-1,1:-1]\n",
    "Qber = identity_matrix(len(states)-2) - Pber[1:-1,1:-1]\n",
    "\n",
    "Phimor = Qmor.solve_right(vector(Pmor[1:-1,-1]))\n",
    "Phibin = Qbin.solve_right(vector(Pbin[1:-1,-1]))\n",
    "Phiber = Qber.solve_right(vector(Pber[1:-1,-1]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way\n",
    "Phimor = Phimor.change_ring(SR).change_ring(F)\n",
    "Phibin = Phibin.change_ring(SR).change_ring(F)\n",
    "Phiber = Phiber.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBin = Qbin.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBin = TimeBin.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBer = Qber.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBer = TimeBer.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMor = Qmor.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMor = TimeMor.change_ring(SR).change_ring(F)\n",
    "\n",
    "# Conditionated times\n",
    "PmorF = copy(Pmor)\n",
    "PberF = copy(Pber)\n",
    "PbinF = copy(Pbin)\n",
    "\n",
    "for i in range(1,len(states)-1):\n",
    "    PmorF.rescale_col(i, Phimor[i-1])\n",
    "    PmorF.rescale_row(i, 1/Phimor[i-1])\n",
    "    \n",
    "    PberF.rescale_col(i, Phiber[i-1])\n",
    "    PberF.rescale_row(i, 1/Phiber[i-1])\n",
    "    \n",
    "    PbinF.rescale_col(i, Phibin[i-1])\n",
    "    PbinF.rescale_row(i, 1/Phibin[i-1])\n",
    "\n",
    "QmorF = identity_matrix(len(states)-2) - PmorF[1:-1,1:-1]\n",
    "QbinF = identity_matrix(len(states)-2) - PbinF[1:-1,1:-1]\n",
    "QberF = identity_matrix(len(states)-2) - PberF[1:-1,1:-1]\n",
    "    \n",
    "TimeBinF = QbinF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBinF = TimeBinF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBerF = QberF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBerF = TimeBerF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMorF = QmorF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMorF = TimeMorF.change_ring(SR).change_ring(F)\n",
    "\n",
    "#TimeMorNF = ((TimeMor - Phimor[0] * TimeMorF) / (1 - Phimor[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 118,
   "id": "f1cd4438",
   "metadata": {},
   "outputs": [],
   "source": [
    "rs = [1/10,1/10+1/80..2/10]\n",
    "rs.extend([2/10,2/10+1/40..1][1:-1])\n",
    "rs.extend([1,1+1/10..10])\n",
    "pcsbin = []\n",
    "pcsber = []\n",
    "tmpbin = (meanPhibin - meanPhimor)\n",
    "tmpber = (meanPhiber - meanPhimor)\n",
    "for valr in rs:\n",
    "    if valr == 0:\n",
    "        pcsbin.append(0)\n",
    "        pcsber.append(0)\n",
    "    else:\n",
    "        pcsbin.append(pc(tmpbin.numerator().subs(r=valr)))\n",
    "        pcsber.append(pc(tmpber.numerator().subs(r=valr)))\n",
    "    "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 119,
   "id": "e1d86b5a",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=1) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 120,
   "id": "513b6731",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.loglog(rs, pcsbin)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 121,
   "id": "bc927278",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, pcsbin)\n",
    "plt.gca().set_scale(\"log\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 122,
   "id": "a4e34507",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, pcsbin)\n",
    "plt.gca().set_xscale(\"log\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 123,
   "id": "e6199407",
   "metadata": {},
   "outputs": [],
   "source": [
    "%%time\n",
    "N = 6\n",
    "\n",
    "states = list(it.product((0,1), range(N)))\n",
    "istates = { s:i for i,s in enumerate(states) }\n",
    "\n",
    "Pmor = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pbin = matrix(F, [[0]* len(states)] * len(states))\n",
    "Pber = matrix(F, [[0]* len(states)] * len(states))\n",
    "\n",
    "Pmor[0,0] = Pbin[0,0] = Pber[0,0] = 1\n",
    "Pmor[len(states)-1, len(states)-1] = Pbin[len(states)-1, len(states)-1] = Pber[len(states)-1, len(states)-1] = 1\n",
    "\n",
    "for i in range(N):\n",
    "    # null center\n",
    "    if i != 0:\n",
    "        Pmor[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i)\n",
    "        Pber[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "        Pbin[istates[(0,i)],istates[(1,i)]] = r*i / (r*i + N-i) * p\n",
    "\n",
    "        Pmor[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pber[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        Pbin[istates[(0,i)],istates[(0,i-1)]] = 1 / (r*i + N-i) * i / (N-1)\n",
    "        \n",
    "        Pmor[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pmor.row(istates[(0,i)]))\n",
    "        Pber[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pber.row(istates[(0,i)]))\n",
    "        Pbin[istates[(0,i)],istates[(0,i)]] = 1 - sum(Pbin.row(istates[(0,i)]))\n",
    "        \n",
    "    \n",
    "    if i != N-1:\n",
    "        Pmor[istates[(1,i)],istates[(1,i+1)]] = r / (r*(i+1) + N-i-1) * (N-1-i) / (N-1)\n",
    "        Pber[istates[(1,i)],istates[(1,N-1)]] = r / (r*(i+1) + N-i-1) * p\n",
    "        for k in [1..N-i-1]:\n",
    "            Pbin[istates[(1,i)],istates[(1,i+k)]] = r / (r*(i+1) + N-i-1) * binomial(N-i-1, k) * p**k * (1-p)**(N-i-1 - k)\n",
    "\n",
    "        Pmor[istates[(1,i)],istates[(0,i)]] = (N-i-1) / (r*(i+1) + N-i-1)\n",
    "        Pber[istates[(1,i)],istates[(0,i)]] = (N-i-1) / (r*(i+1) + N-i-1)\n",
    "        Pbin[istates[(1,i)],istates[(0,i)]] = (N-i-1) / (r*(i+1) + N-i-1)\n",
    "        \n",
    "        Pmor[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pmor.row(istates[(1,i)]))\n",
    "        Pber[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pber.row(istates[(1,i)]))\n",
    "        Pbin[istates[(1,i)],istates[(1,i)]] = 1 - sum(Pbin.row(istates[(1,i)]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way.. \n",
    "Pmor = Pmor.change_ring(SR).change_ring(F)\n",
    "Pber = Pber.change_ring(SR).change_ring(F)\n",
    "Pbin = Pbin.change_ring(SR).change_ring(F)\n",
    "\n",
    "Qmor = identity_matrix(len(states)-2) - Pmor[1:-1,1:-1]\n",
    "Qbin = identity_matrix(len(states)-2) - Pbin[1:-1,1:-1]\n",
    "Qber = identity_matrix(len(states)-2) - Pber[1:-1,1:-1]\n",
    "\n",
    "Phimor = Qmor.solve_right(vector(Pmor[1:-1,-1]))\n",
    "Phibin = Qbin.solve_right(vector(Pbin[1:-1,-1]))\n",
    "Phiber = Qber.solve_right(vector(Pber[1:-1,-1]))\n",
    "\n",
    "\n",
    "# Simplifications... I have not managed to do it in a reasonable way\n",
    "Phimor = Phimor.change_ring(SR).change_ring(F)\n",
    "Phibin = Phibin.change_ring(SR).change_ring(F)\n",
    "Phiber = Phiber.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBin = Qbin.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBin = TimeBin.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBer = Qber.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBer = TimeBer.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMor = Qmor.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMor = TimeMor.change_ring(SR).change_ring(F)\n",
    "\n",
    "# Conditionated times\n",
    "PmorF = copy(Pmor)\n",
    "PberF = copy(Pber)\n",
    "PbinF = copy(Pbin)\n",
    "\n",
    "for i in range(1,len(states)-1):\n",
    "    PmorF.rescale_col(i, Phimor[i-1])\n",
    "    PmorF.rescale_row(i, 1/Phimor[i-1])\n",
    "    \n",
    "    PberF.rescale_col(i, Phiber[i-1])\n",
    "    PberF.rescale_row(i, 1/Phiber[i-1])\n",
    "    \n",
    "    PbinF.rescale_col(i, Phibin[i-1])\n",
    "    PbinF.rescale_row(i, 1/Phibin[i-1])\n",
    "\n",
    "QmorF = identity_matrix(len(states)-2) - PmorF[1:-1,1:-1]\n",
    "QbinF = identity_matrix(len(states)-2) - PbinF[1:-1,1:-1]\n",
    "QberF = identity_matrix(len(states)-2) - PberF[1:-1,1:-1]\n",
    "    \n",
    "TimeBinF = QbinF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBinF = TimeBinF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeBerF = QberF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeBerF = TimeBerF.change_ring(SR).change_ring(F)\n",
    "\n",
    "TimeMorF = QmorF.solve_right(vector([1]*(len(states)-2)))\n",
    "TimeMorF = TimeMorF.change_ring(SR).change_ring(F)\n",
    "\n",
    "#TimeMorNF = ((TimeMor - Phimor[0] * TimeMorF) / (1 - Phimor[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 124,
   "id": "052ba63d",
   "metadata": {},
   "outputs": [],
   "source": [
    "MeanTimeBin = 1/N * TimeBin[istates[(1,0)]] + (N-1)/N * TimeBin[istates[(0,1)]]\n",
    "MeanTimeBer = 1/N * TimeBer[istates[(1,0)]] + (N-1)/N * TimeBer[istates[(0,1)]]\n",
    "MeanTimeMor = 1/N * TimeMor[istates[(1,0)]] + (N-1)/N * TimeMor[istates[(0,1)]]\n",
    "\n",
    "MeanTimeBinF = 1/N * TimeBinF[istates[(1,0)]] + (N-1)/N * TimeBinF[istates[(0,1)]]\n",
    "MeanTimeBerF = 1/N * TimeBerF[istates[(1,0)]] + (N-1)/N * TimeBerF[istates[(0,1)]]\n",
    "MeanTimeMorF = 1/N * TimeMorF[istates[(1,0)]] + (N-1)/N * TimeMorF[istates[(0,1)]]\n",
    "\n",
    "meanPhimor = 1/N * Phimor[istates[(1,0)]] + (N-1)/N * Phimor[istates[(0,1)]]\n",
    "MeanTimeMorNF = ((MeanTimeMor - meanPhimor * MeanTimeMorF) / (1 - meanPhimor))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "meanPhibin = 1/N * Phibin[istates[(1,0)]] + (N-1)/N * Phibin[istates[(0,1)]]\n",
    "MeanTimeBinNF = ((MeanTimeBin - meanPhibin * MeanTimeBinF) / (1 - meanPhibin))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "meanPhiber = 1/N * Phiber[istates[(1,0)]] + (N-1)/N * Phiber[istates[(0,1)]]\n",
    "MeanTimeBerNF = ((MeanTimeBer - meanPhiber * MeanTimeBerF) / (1 - meanPhiber))#.change_ring(SR).change_ring(F)\n",
    "\n",
    "                 #TimeBerNF = ((TimeBer - Phiber[0] * TimeBerF) / (1 - Phiber[0])).change_ring(SR).change_ring(F)\n",
    "#TimeBinNF = ((TimeBin - Phibin[0] * TimeBinF) / (1 - Phibin[0])).change_ring(SR).change_ring(F)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 125,
   "id": "a15c4478",
   "metadata": {},
   "outputs": [],
   "source": [
    "maxr = 4\n",
    "plot3d(log(MeanTimeBinF), (r,0,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMorF), (r,0,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBerF), (r,0,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 126,
   "id": "a499d51e",
   "metadata": {},
   "outputs": [],
   "source": [
    "plot3d(log(MeanTimeBinNF), (r,0,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMorNF), (r,0,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBerNF), (r,0,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 127,
   "id": "e532b26a",
   "metadata": {},
   "outputs": [],
   "source": [
    "plot3d(log(MeanTimeBin), (r,0,maxr), (p,0,1), color=\"orange\") + \\\n",
    "    plot3d(log(MeanTimeMor), (r,0,maxr), (p,0,1), color=\"blue\") + \\\n",
    "        plot3d(log(MeanTimeBer), (r,0,maxr), (p,0,1), color=\"red\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 128,
   "id": "01d38769",
   "metadata": {},
   "outputs": [],
   "source": [
    "def pc(f):\n",
    "    a = 0\n",
    "    sa = (f(p=a) > 0)\n",
    "    b = 1\n",
    "    while b-a > 1e-18:\n",
    "        c = (a+b)/2\n",
    "        sc = (f(p=c) > 0)\n",
    "        if sc ^ sa:\n",
    "            a = c\n",
    "        else:\n",
    "            b = c\n",
    "    \n",
    "    return n((b+a) / 2)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 129,
   "id": "df166703",
   "metadata": {},
   "outputs": [],
   "source": [
    "rs = [1/10,1/10+1/80..2/10]\n",
    "rs.extend([2/10,2/10+1/40..1][1:-1])\n",
    "rs.extend([1,1+1/10..10])\n",
    "pcsbin = []\n",
    "pcsber = []\n",
    "tmpbin = (meanPhibin - meanPhimor)\n",
    "tmpber = (meanPhiber - meanPhimor)\n",
    "for valr in rs:\n",
    "    if valr == 0:\n",
    "        pcsbin.append(0)\n",
    "        pcsber.append(0)\n",
    "    else:\n",
    "        pcsbin.append(pc(tmpbin.numerator().subs(r=valr)))\n",
    "        pcsber.append(pc(tmpber.numerator().subs(r=valr)))\n",
    "    "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 130,
   "id": "8bbbd85f",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=1) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 131,
   "id": "5f6fb728",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, pcsbin)\n",
    "plt.gca().set_xscale(\"log\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 132,
   "id": "71237e3c",
   "metadata": {},
   "outputs": [],
   "source": [
    "def pc(f):\n",
    "    a = 0\n",
    "    sa = (f(p=a) > 0)\n",
    "    b = 1\n",
    "    while b-a > 1e-18:\n",
    "        c = (a+b)/2\n",
    "        sc = (f(p=c) > 0)\n",
    "        if sc ^ sa:\n",
    "            a = c\n",
    "        else:\n",
    "            b = c\n",
    "    \n",
    "    return n((b+a) / 2)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 133,
   "id": "a84d3e81",
   "metadata": {},
   "outputs": [],
   "source": [
    "rs = [1/10,1/10+1/80..2/10]\n",
    "rs.extend([2/10,2/10+1/40..1][1:-1])\n",
    "rs.extend([1,1+1/10..10])\n",
    "pcsbin = []\n",
    "pcsber = []\n",
    "tmpbin = (meanPhibin - meanPhimor)\n",
    "tmpber = (meanPhiber - meanPhimor)\n",
    "for valr in rs:\n",
    "    if valr == 0:\n",
    "        pcsbin.append(0)\n",
    "        pcsber.append(0)\n",
    "    else:\n",
    "        pcsbin.append(pc(tmpbin.numerator().subs(r=valr)))\n",
    "        pcsber.append(pc(tmpber.numerator().subs(r=valr)))\n",
    "    "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 134,
   "id": "78553e87",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=1) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 135,
   "id": "9d3f4dd4",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, pcsbin)\n",
    "plt.gca().set_xscale(\"log\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 136,
   "id": "acc6ac4d",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=8) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 137,
   "id": "4a088e22",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=.3) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 138,
   "id": "73f4f445",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=.4) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 139,
   "id": "fdda2ef2",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=.9) for v in rs])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 140,
   "id": "dfcea21d",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(rs, [meanPhimor(r=v) for v in rs])\n",
    "plt.plot(rs, [meanPhibin(r=v,p=1) for v in rs])"
   ]
  }
 ],
 "metadata": {},
 "nbformat": 4,
 "nbformat_minor": 5
}
